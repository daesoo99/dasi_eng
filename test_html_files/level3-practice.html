<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASI English - Level 3 ì—°ìŠµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #7c3aed, #c026d3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stage-info {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .phase-indicator {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
            text-align: center;
        }
        
        .question-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .korean-text {
            font-size: 1.8em;
            color: #1f2937;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .answer-input {
            font-size: 1.5em;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #c026d3);
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .progress {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #7c3aed, #c026d3);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            display: none;
        }
        
        .feedback.correct {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .feedback.incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: #f1f5f9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #7c3aed;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .grammar-pattern {
            background: #fef3c7;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .korean-text {
                font-size: 1.4em;
            }
            
            .answer-input {
                font-size: 1.2em;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Level 3 ì—°ìŠµ</h1>
            <p id="stage-title">ì‹œì œÂ·íƒœÂ·ë…¼ë¦¬ í™•ì¥ íŒ¨í„´</p>
            <div class="stage-info">
                <div class="phase-indicator" id="phase-indicator">Phase 1</div>
                <div id="stage-description">ìŠ¤í…Œì´ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                <div class="progress">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                    <span id="current-question">1</span>
                    <span id="total-questions">15</span>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="correct-count">0</div>
                    <div class="stat-label">ì •ë‹µ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracy">0%</div>
                    <div class="stat-label">ì •í™•ë„</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="remaining">15</div>
                    <div class="stat-label">ë‚¨ì€ ë¬¸ì œ</div>
                </div>
            </div>
            
            <div class="grammar-pattern" id="grammar-pattern">
                ë¬¸ë²• íŒ¨í„´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <div class="question-card">
                <div class="korean-text" id="korean-question">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                <input type="text" class="answer-input" id="answer-input" placeholder="ì˜ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”" autocomplete="off">
                <div class="feedback" id="feedback"></div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-primary" id="check-btn">âœ“ ë‹µì•ˆ í™•ì¸</button>
                <button class="btn btn-secondary" id="skip-btn">â†’ ë„˜ì–´ê°€ê¸°</button>
                <button class="btn btn-secondary" id="hint-btn">ğŸ’¡ íŒíŠ¸</button>
                <button class="btn btn-ai" id="ai-btn">ğŸ¤– AI ì½”ì¹­</button>
                <a href="level-system.html" class="btn btn-danger">â† ëŒì•„ê°€ê¸°</a>
            </div>
        </div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ìŠ¤í…Œì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const stageNumber = parseInt(urlParams.get('stage')) || 1;
        
        // Level 3 ìŠ¤í…Œì´ì§€ ë°ì´í„° ë¡œë“œ
        let stageData = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        let totalAttempts = 0;
        
        // Level 3 JSON ë°ì´í„°ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ
        async function loadLevel3Data() {
            try {
                const response = await fetch('/patterns/level_3_advanced_grammar/lv3_stage_system.json');
                const data = await response.json();
                
                stageData = data.stages.find(stage => stage.stage === stageNumber);
                if (!stageData) {
                    throw new Error(`Stage ${stageNumber} not found`);
                }
                
                initializeStage();
            } catch (error) {
                console.error('Level 3 ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ìŠ¤í…Œì´ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°œë°œì ëª¨ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                // ê°œë°œì ëª¨ë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë”ë¯¸ ë°ì´í„°
                loadDummyData();
            }
        }
        
        // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„°
        function loadDummyData() {
            stageData = {
                stage: stageNumber,
                phase: 1,
                title: "ë¯¸ë˜í˜• ì‹¬í™” (will vs be going to)",
                grammar_focus: "ì˜ë„/ê³„íš vs ì˜ˆì¸¡/ì¦‰ì„ ê²°ì •ì˜ êµ¬ë¶„",
                patterns: [
                    "I'm going to + [ë™ì‚¬ì›í˜•] (ê³„íš)",
                    "I will + [ë™ì‚¬ì›í˜•] (ì¦‰ì„ ê²°ì •)",
                    "It's going to + [ë™ì‚¬ì›í˜•] (ì˜ˆì¸¡)"
                ],
                sentence_variations: {
                    planned_actions: [
                        {"en": "I'm going to study abroad next year", "ko": "ë‚˜ëŠ” ë‚´ë…„ì— ìœ í•™ê°ˆ ì˜ˆì •ì´ì•¼"},
                        {"en": "We're going to move to Seoul", "ko": "ìš°ë¦¬ëŠ” ì„œìš¸ë¡œ ì´ì‚¬í•  ì˜ˆì •ì´ì•¼"},
                        {"en": "She's going to change her job", "ko": "ê·¸ë…€ëŠ” ì§ì—…ì„ ë°”ê¿€ ì˜ˆì •ì´ì•¼"},
                        {"en": "They're going to buy a new car", "ko": "ê·¸ë“¤ì€ ìƒˆ ì°¨ë¥¼ ì‚´ ì˜ˆì •ì´ì•¼"},
                        {"en": "He's going to learn English", "ko": "ê·¸ëŠ” ì˜ì–´ë¥¼ ë°°ìš¸ ì˜ˆì •ì´ì•¼"}
                    ],
                    spontaneous_decisions: [
                        {"en": "I will help you with that", "ko": "ê·¸ê²ƒ ë„ì™€ì¤„ê²Œ"},
                        {"en": "We will call you later", "ko": "ë‚˜ì¤‘ì— ì „í™”í• ê²Œ"},
                        {"en": "She will answer the phone", "ko": "ê·¸ë…€ê°€ ì „í™”ë¥¼ ë°›ì„ê²Œ"},
                        {"en": "They will fix this problem", "ko": "ê·¸ë“¤ì´ ì´ ë¬¸ì œë¥¼ í•´ê²°í• ê²Œ"},
                        {"en": "He will drive you home", "ko": "ê·¸ê°€ ì§‘ê¹Œì§€ ë°ë ¤ë‹¤ì¤„ê²Œ"}
                    ],
                    predictions: [
                        {"en": "It's going to rain tomorrow", "ko": "ë‚´ì¼ ë¹„ê°€ ì˜¬ ê²ƒ ê°™ì•„"},
                        {"en": "The meeting is going to be long", "ko": "íšŒì˜ê°€ ê¸¸ì–´ì§ˆ ê²ƒ ê°™ì•„"},
                        {"en": "This project is going to succeed", "ko": "ì´ í”„ë¡œì íŠ¸ëŠ” ì„±ê³µí•  ê²ƒ ê°™ì•„"},
                        {"en": "The test is going to be difficult", "ko": "ì‹œí—˜ì´ ì–´ë ¤ìš¸ ê²ƒ ê°™ì•„"},
                        {"en": "Traffic is going to be heavy", "ko": "êµí†µì´ ë§‰í ê²ƒ ê°™ì•„"}
                    ]
                }
            };
            
            initializeStage();
        }
        
        // ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”
        function initializeStage() {
            // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('stage-title').textContent = `Stage ${stageNumber}: ${stageData.title}`;
            document.getElementById('stage-description').textContent = stageData.grammar_focus;
            document.getElementById('phase-indicator').textContent = `Phase ${stageData.phase}`;
            document.getElementById('grammar-pattern').textContent = stageData.patterns ? stageData.patterns.join(' / ') : 'ê³ ê¸‰ ë¬¸ë²• íŒ¨í„´';
            
            // ëª¨ë“  ë¬¸ì¥ ë³€í˜•ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê¸°
            currentQuestions = [];
            
            Object.values(stageData.sentence_variations).forEach(variations => {
                currentQuestions.push(...variations);
            });
            
            // ë¬¸ì œ ìˆœì„œ ì„ê¸°
            currentQuestions = shuffleArray(currentQuestions);
            
            // ì´ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('total-questions').textContent = currentQuestions.length;
            document.getElementById('remaining').textContent = currentQuestions.length;
            
            // ì²« ë²ˆì§¸ ë¬¸ì œ í‘œì‹œ
            showCurrentQuestion();
        }
        
        // ë°°ì—´ ì„ê¸° í•¨ìˆ˜
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // í˜„ì¬ ë¬¸ì œ í‘œì‹œ
        function showCurrentQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            
            // ë¬¸ì œ í‘œì‹œ
            document.getElementById('korean-question').textContent = question.ko;
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
            
            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('remaining').textContent = currentQuestions.length - currentQuestionIndex;
            
            const progress = ((currentQuestionIndex) / currentQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            
            // í”¼ë“œë°± ìˆ¨ê¸°ê¸°
            document.getElementById('feedback').style.display = 'none';
        }
        
        // ë‹µì•ˆ í™•ì¸
        function checkAnswer() {
            const userAnswer = document.getElementById('answer-input').value.trim().toLowerCase();
            const correctAnswer = currentQuestions[currentQuestionIndex].en.toLowerCase();
            const feedback = document.getElementById('feedback');
            
            totalAttempts++;
            
            // ê°„ë‹¨í•œ ë‹µì•ˆ ê²€ì¦ (ê³µë°±ê³¼ ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, êµ¬ë‘ì  í—ˆìš©)
            const normalizeAnswer = (text) => {
                return text.replace(/[.,!?]/g, '').replace(/\s+/g, ' ').trim();
            };
            
            const isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);
            
            if (isCorrect) {
                correctAnswers++;
                feedback.className = 'feedback correct';
                feedback.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!';
                feedback.style.display = 'block';
                
                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = `âŒ ì •ë‹µ: ${currentQuestions[currentQuestionIndex].en}`;
                feedback.style.display = 'block';
                
                setTimeout(() => {
                    nextQuestion();
                }, 2500);
            }
            
            updateStats();
        }
        
        // ë‹¤ìŒ ë¬¸ì œë¡œ
        function nextQuestion() {
            currentQuestionIndex++;
            showCurrentQuestion();
        }
        
        // ë„˜ì–´ê°€ê¸°
        function skipQuestion() {
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback incorrect';
            feedback.textContent = `ì •ë‹µ: ${currentQuestions[currentQuestionIndex].en}`;
            feedback.style.display = 'block';
            
            totalAttempts++;
            
            setTimeout(() => {
                nextQuestion();
            }, 2000);
            
            updateStats();
        }
        
        // íŒíŠ¸ í‘œì‹œ
        function showHint() {
            const correctAnswer = currentQuestions[currentQuestionIndex].en;
            const words = correctAnswer.split(' ');
            const hint = words[0] + (words.length > 1 ? ' ...' : '...');
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback';
            feedback.style.background = '#fef3c7';
            feedback.style.color = '#92400e';
            feedback.style.border = '2px solid #f59e0b';
            feedback.textContent = `ğŸ’¡ íŒíŠ¸: ${hint}`;
            feedback.style.display = 'block';
        }
        
        // AI ì½”ì¹­ ê¸°ëŠ¥
        async function showAICoaching() {
            const userAnswer = document.getElementById('answer-input').value.trim();
            const correctAnswer = currentQuestions[currentQuestionIndex].en;
            const koreanQuestion = currentQuestions[currentQuestionIndex].ko;
            const feedback = document.getElementById('feedback');
            
            if (!userAnswer) {
                feedback.className = 'feedback';
                feedback.style.background = '#fff3cd';
                feedback.style.color = '#856404';
                feedback.style.border = '2px solid #ffc107';
                feedback.textContent = 'ğŸ¤– ë¨¼ì € ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
                feedback.style.display = 'block';
                return;
            }
            
            // AI ë¶„ì„ ì¤‘ í‘œì‹œ
            feedback.className = 'feedback';
            feedback.style.background = '#e3f2fd';
            feedback.style.color = '#1565c0';
            feedback.style.border = '2px solid #2196f3';
            feedback.innerHTML = 'ğŸ¤– AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... <div style="margin-top: 10px;"><div style="width: 20px; height: 20px; border: 2px solid #ccc; border-top: 2px solid #1565c0; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div></div>';
            feedback.style.display = 'block';
            
            try {
                // AI í”¼ë“œë°± ìƒì„±
                const aiResponse = await getAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData);
                
                feedback.className = 'feedback';
                feedback.style.background = '#f3e5f5';
                feedback.style.color = '#7b1fa2';
                feedback.style.border = '2px solid #9c27b0';
                feedback.innerHTML = aiResponse;
                feedback.style.display = 'block';
                
            } catch (error) {
                console.error('AI í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨:', error);
                feedback.className = 'feedback';
                feedback.style.background = '#ffebee';
                feedback.style.color = '#c62828';
                feedback.style.border = '2px solid #f44336';
                feedback.textContent = 'ğŸ¤– AI ì„œë¹„ìŠ¤ì— ì¼ì‹œì  ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                feedback.style.display = 'block';
            }
        }
        
        // AI í”¼ë“œë°± ìƒì„± í•¨ìˆ˜
        async function getAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData) {
            // Google Gemini APIë¥¼ ì‚¬ìš©í•œ AI í”¼ë“œë°± ìƒì„±
            const apiKey = 'YOUR_GEMINI_API_KEY'; // ì‹¤ì œ ì‚¬ìš© ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
            
            if (apiKey === 'YOUR_GEMINI_API_KEY') {
                // API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ì‹œë®¬ë ˆì´ì…˜
                return generateMockAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData);
            }
            
            const prompt = `
í•œêµ­ì¸ ì˜ì–´ í•™ìŠµìë¥¼ ìœ„í•œ Level 3 ê³ ê¸‰ ë¬¸ë²• ì½”ì¹­ì„ í•´ì£¼ì„¸ìš”.

**í˜„ì¬ í•™ìŠµ ì •ë³´:**
- Stage ${stageData.stage}: ${stageData.title}
- Phase ${stageData.phase} (${stageData.grammar_focus})
- ë¬¸ë²• íŒ¨í„´: ${stageData.patterns.join(', ')}

**ë¬¸ì œ ìƒí™©:**
- í•œêµ­ì–´ ë¬¸ì¥: "${koreanQuestion}"
- ì •ë‹µ: "${correctAnswer}"
- ì‚¬ìš©ì ë‹µë³€: "${userAnswer}"

**ìš”ì²­ì‚¬í•­:**
1. ì‚¬ìš©ì ë‹µë³€ê³¼ ì •ë‹µì˜ ì°¨ì´ì  ë¶„ì„
2. ë¬¸ë²• íŒ¨í„´ ê´€ì ì—ì„œ êµì • í¬ì¸íŠ¸ ì œì‹œ
3. í•œêµ­ì¸ì´ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜ íŒ¨í„´ì´ë¼ë©´ êµ¬ì²´ì  ì„¤ëª…
4. ì•”ê¸°í•˜ê¸° ì‰¬ìš´ íŒì´ë‚˜ ì—°ìƒë²• ì œì•ˆ
5. ê²©ë ¤ì˜ ë©”ì‹œì§€ í¬í•¨

**ì‘ë‹µ í˜•ì‹:** 
ğŸ¯ **ë¶„ì„**: [ê°„ë‹¨í•œ ì°¨ì´ì  ë¶„ì„]
ğŸ“š **ë¬¸ë²• í¬ì¸íŠ¸**: [í•µì‹¬ ë¬¸ë²• ì„¤ëª…]  
ğŸ’¡ **í•œêµ­ì¸ íŠ¹í™” íŒ**: [í•œêµ­ì–´-ì˜ì–´ ì°¨ì´ ê¸°ë°˜ ì¡°ì–¸]
âœ¨ **ê¸°ì–µë²•**: [ì•”ê¸° íŒ]
ğŸ”¥ **ê²©ë ¤**: [ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€]

ê°„ê²°í•˜ê³  ì¹œê·¼í•˜ê²Œ, 300ì ì´ë‚´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
            `;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
                
            } catch (error) {
                console.error('Gemini API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                return generateMockAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData);
            }
        }
        
        // ëª¨ì˜ AI í”¼ë“œë°± ìƒì„± (API í‚¤ ì—†ì„ ë•Œ)
        function generateMockAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData) {
            const isCorrect = userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim();
            
            if (isCorrect) {
                return `
ğŸ¯ **ì™„ë²½í•©ë‹ˆë‹¤!** "${userAnswer}" ì •í™•í•œ ë‹µë³€ì´ì—ìš”!<br><br>
ğŸ“š **ë¬¸ë²• í¬ì¸íŠ¸**: ${stageData.patterns[0]}ì„ ì •í™•íˆ ì ìš©í–ˆë„¤ìš”.<br>
ğŸ’¡ **í•œêµ­ì¸ íŠ¹í™” íŒ**: ì´ íŒ¨í„´ì€ ${stageData.grammar_focus}ì˜ í•µì‹¬ì…ë‹ˆë‹¤.<br>
âœ¨ **ê¸°ì–µë²•**: íŒ¨í„´ êµ¬ì¡°ë¥¼ ëª¸ì— ìµí˜”ë„¤ìš”, ê³„ì† ì´ ì¡°ìë¡œ!<br>
ğŸ”¥ **ê²©ë ¤**: ê³ ê¸‰ ë¬¸ë²•ì„ ì •í™•íˆ ì‚¬ìš©í•˜ê³  ìˆì–´ìš”. ì‹¤ë ¥ì´ ëŠ˜ê³  ìˆìŠµë‹ˆë‹¤! ğŸ’ª
                `;
            }
            
            const differences = findKeyDifferences(userAnswer, correctAnswer);
            const grammarTip = getGrammarTip(stageData);
            const memoryTip = getMemoryTip(stageData, correctAnswer);
            
            return `
ğŸ¯ **ë¶„ì„**: ${differences}<br><br>
ğŸ“š **ë¬¸ë²• í¬ì¸íŠ¸**: ${grammarTip}<br>
ğŸ’¡ **í•œêµ­ì¸ íŠ¹í™” íŒ**: "${correctAnswer}" ì–´ìˆœì— ì£¼ì˜í•˜ì„¸ìš”!<br>
âœ¨ **ê¸°ì–µë²•**: ${memoryTip}<br>
ğŸ”¥ **ê²©ë ¤**: ê³ ê¸‰ íŒ¨í„´ì€ ì—°ìŠµì´ í•„ìš”í•´ìš”. í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”! ğŸŒŸ
            `;
        }
        
        // ë‹µë³€ ì°¨ì´ì  ë¶„ì„
        function findKeyDifferences(userAnswer, correctAnswer) {
            if (!userAnswer) return "ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            
            const userWords = userAnswer.toLowerCase().trim().split(/\s+/);
            const correctWords = correctAnswer.toLowerCase().trim().split(/\s+/);
            
            if (userWords.length !== correctWords.length) {
                return `ë‹¨ì–´ ê°œìˆ˜ê°€ ë‹¤ë¦…ë‹ˆë‹¤ (ì…ë ¥: ${userWords.length}ê°œ, ì •ë‹µ: ${correctWords.length}ê°œ)`;
            }
            
            for (let i = 0; i < correctWords.length; i++) {
                if (userWords[i] !== correctWords[i]) {
                    return `"${userWords[i]}" â†’ "${correctWords[i]}"ë¡œ ìˆ˜ì • í•„ìš”`;
                }
            }
            
            return "ê±°ì˜ ì •í™•í•˜ì§€ë§Œ ì„¸ë¶€ì‚¬í•­ì„ í™•ì¸í•´ë³´ì„¸ìš”.";
        }
        
        // ë¬¸ë²• íŒ ìƒì„±
        function getGrammarTip(stageData) {
            const tips = {
                1: "ë¯¸ë˜ í‘œí˜„: ê³„íš(be going to) vs ì¦‰ì„ê²°ì •(will) êµ¬ë¶„ì´ í•µì‹¬",
                2: "í˜„ì¬ì™„ë£Œ: ê²½í—˜(ever/never)ê³¼ ì™„ë£Œ(just) ìš©ë²• ì°¨ì´",
                3: "í˜„ì¬ì™„ë£Œ ê³„ì†: for(ê¸°ê°„) vs since(ì‹œì ) êµ¬ë¶„",
                4: "ê³¼ê±°ì™„ë£Œ: ê³¼ê±°ë³´ë‹¤ ë” ì´ì „ ì‹œì  í‘œí˜„ (had + p.p.)",
                5: "ìˆ˜ë™íƒœ ê¸°ë³¸: beë™ì‚¬ + ê³¼ê±°ë¶„ì‚¬ êµ¬ì¡°",
                6: "ìˆ˜ë™íƒœ ì‹¬í™”: ì¡°ë™ì‚¬ì™€ ìˆ˜ë™íƒœ ê²°í•©",
                7: "ì¡°ë™ì‚¬: would(ì™„ê³¡), could(ê°€ëŠ¥), might(ì¶”ì¸¡) ë‰˜ì•™ìŠ¤",
                8: "ì¡°ë™ì‚¬ ê³¼ê±°: should have(í›„íšŒ), could have(ê°€ëŠ¥ì„±) í‘œí˜„",
                9: "ì¡°ê±´ë¬¸: 1í˜•ì‹(í˜„ì‹¤) vs 2í˜•ì‹(ê°€ì •) êµ¬ë¶„",
                10: "ê°€ì •ë²• ê³¼ê±°: If I were you íŒ¨í„´ìœ¼ë¡œ ì¡°ì–¸",
                11: "ê°€ì •ë²• ê³¼ê±°ì™„ë£Œ: ê³¼ê±°ì— ëŒ€í•œ í›„íšŒ í‘œí˜„"
            };
            return tips[stageData.stage] || `${stageData.title}ì˜ í•µì‹¬ ë¬¸ë²• êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
        }
        
        // ê¸°ì–µë²• íŒ ìƒì„±
        function getMemoryTip(stageData, correctAnswer) {
            const patterns = [
                "ì–´ìˆœì„ ì†Œë¦¬ ë‚´ì–´ ë°˜ë³µí•´ë³´ì„¸ìš”: " + correctAnswer,
                "ì²« ë‹¨ì–´ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ê¸°ì–µí•˜ì„¸ìš”: " + correctAnswer.split(' ')[0] + "...",
                "ë¬¸ì¥ì„ 3ë²ˆ í° ì†Œë¦¬ë¡œ ì½ì–´ë³´ì„¸ìš”!",
                "íŒ¨í„´ êµ¬ì¡°ë¥¼ ëª¸ì— ìµíˆëŠ” ê²Œ ì¤‘ìš”í•´ìš”.",
                "ë¹„ìŠ·í•œ ë¬¸ì¥ì„ 5ê°œ ë” ë§Œë“¤ì–´ë³´ì„¸ìš”!"
            ];
            
            return patterns[Math.floor(Math.random() * patterns.length)];
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('correct-count').textContent = correctAnswers;
            
            const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function showResults() {
            const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
            
            alert(`
ğŸ‰ Stage ${stageNumber} ì™„ë£Œ!

ğŸ“Š ê²°ê³¼:
â€¢ ì •ë‹µ: ${correctAnswers}/${totalAttempts}
â€¢ ì •í™•ë„: ${accuracy}%
â€¢ íŒ¨í„´: ${stageData.title}

${accuracy >= 85 ? 'âœ… ëª©í‘œ ë‹¬ì„±!' : 'ğŸ“š ë” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.'}
            `);
            
            // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            window.location.href = 'level-system.html';
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('check-btn').addEventListener('click', checkAnswer);
        document.getElementById('skip-btn').addEventListener('click', skipQuestion);
        document.getElementById('hint-btn').addEventListener('click', showHint);
        document.getElementById('ai-btn').addEventListener('click', showAICoaching);
        
        // Enter í‚¤ë¡œ ë‹µì•ˆ í™•ì¸
        document.getElementById('answer-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        // ì´ˆê¸°í™”
        loadLevel3Data();
    </script>
</body>
</html>
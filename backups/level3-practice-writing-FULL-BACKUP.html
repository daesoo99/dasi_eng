<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASI English - Level 3 연습</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #7c3aed, #c026d3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stage-info {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .phase-indicator {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
            text-align: center;
        }
        
        .question-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .korean-text {
            font-size: 1.8em;
            color: #1f2937;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .answer-input {
            font-size: 1.5em;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #c026d3);
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .progress {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #7c3aed, #c026d3);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            display: none;
        }
        
        .feedback.correct {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .feedback.incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: #f1f5f9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #7c3aed;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .grammar-pattern {
            background: #fef3c7;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .korean-text {
                font-size: 1.4em;
            }
            
            .answer-input {
                font-size: 1.2em;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Level 3 연습</h1>
            <p id="stage-title">시제·태·논리 확장 패턴</p>
            <div class="stage-info">
                <div class="phase-indicator" id="phase-indicator">Phase 1</div>
                <div id="stage-description">스테이지 정보를 불러오는 중...</div>
                <div class="progress">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                    <span id="current-question">1</span>
                    <span id="total-questions">15</span>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="correct-count">0</div>
                    <div class="stat-label">정답</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracy">0%</div>
                    <div class="stat-label">정확도</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="remaining">15</div>
                    <div class="stat-label">남은 문제</div>
                </div>
            </div>
            
            <div class="grammar-pattern" id="grammar-pattern">
                문법 패턴을 불러오는 중...
            </div>
            
            <div class="question-card">
                <div class="korean-text" id="korean-question">문제를 불러오는 중...</div>
                <input type="text" class="answer-input" id="answer-input" placeholder="영어로 번역하세요" autocomplete="off">
                <div class="feedback" id="feedback"></div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-primary" id="check-btn">✓ 답안 확인</button>
                <button class="btn btn-secondary" id="skip-btn">→ 넘어가기</button>
                <button class="btn btn-secondary" id="hint-btn">💡 힌트</button>
                <button class="btn btn-ai" id="ai-btn">🤖 AI 코칭</button>
                <a href="level-system.html" class="btn btn-danger">← 돌아가기</a>
            </div>
        </div>
    </div>

    <script>
        // URL 파라미터에서 스테이지 정보 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const stageNumber = parseInt(urlParams.get('stage')) || 1;
        
        // Level 3 스테이지 데이터 로드
        let stageData = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        let totalAttempts = 0;
        
        // Level 3 JSON 데이터를 동적으로 로드
        async function loadLevel3Data() {
            try {
                const response = await fetch('/patterns/level_3_advanced_grammar/lv3_stage_system.json');
                const data = await response.json();
                
                stageData = data.stages.find(stage => stage.stage === stageNumber);
                if (!stageData) {
                    throw new Error(`Stage ${stageNumber} not found`);
                }
                
                initializeStage();
            } catch (error) {
                console.error('Level 3 데이터 로드 실패:', error);
                alert('스테이지 데이터를 불러올 수 없습니다. 개발자 모드를 확인하세요.');
                // 개발자 모드 또는 테스트를 위한 더미 데이터
                loadDummyData();
            }
        }
        
        // 테스트용 더미 데이터
        function loadDummyData() {
            stageData = {
                stage: stageNumber,
                phase: 1,
                title: "미래형 심화 (will vs be going to)",
                grammar_focus: "의도/계획 vs 예측/즉석 결정의 구분",
                patterns: [
                    "I'm going to + [동사원형] (계획)",
                    "I will + [동사원형] (즉석 결정)",
                    "It's going to + [동사원형] (예측)"
                ],
                sentence_variations: {
                    planned_actions: [
                        {"en": "I'm going to study abroad next year", "ko": "나는 내년에 유학갈 예정이야"},
                        {"en": "We're going to move to Seoul", "ko": "우리는 서울로 이사할 예정이야"},
                        {"en": "She's going to change her job", "ko": "그녀는 직업을 바꿀 예정이야"},
                        {"en": "They're going to buy a new car", "ko": "그들은 새 차를 살 예정이야"},
                        {"en": "He's going to learn English", "ko": "그는 영어를 배울 예정이야"}
                    ],
                    spontaneous_decisions: [
                        {"en": "I will help you with that", "ko": "그것 도와줄게"},
                        {"en": "We will call you later", "ko": "나중에 전화할게"},
                        {"en": "She will answer the phone", "ko": "그녀가 전화를 받을게"},
                        {"en": "They will fix this problem", "ko": "그들이 이 문제를 해결할게"},
                        {"en": "He will drive you home", "ko": "그가 집까지 데려다줄게"}
                    ],
                    predictions: [
                        {"en": "It's going to rain tomorrow", "ko": "내일 비가 올 것 같아"},
                        {"en": "The meeting is going to be long", "ko": "회의가 길어질 것 같아"},
                        {"en": "This project is going to succeed", "ko": "이 프로젝트는 성공할 것 같아"},
                        {"en": "The test is going to be difficult", "ko": "시험이 어려울 것 같아"},
                        {"en": "Traffic is going to be heavy", "ko": "교통이 막힐 것 같아"}
                    ]
                }
            };
            
            initializeStage();
        }
        
        // 스테이지 초기화
        function initializeStage() {
            // 헤더 정보 업데이트
            document.getElementById('stage-title').textContent = `Stage ${stageNumber}: ${stageData.title}`;
            document.getElementById('stage-description').textContent = stageData.grammar_focus;
            document.getElementById('phase-indicator').textContent = `Phase ${stageData.phase}`;
            document.getElementById('grammar-pattern').textContent = stageData.patterns ? stageData.patterns.join(' / ') : '고급 문법 패턴';
            
            // 모든 문장 변형을 하나의 배열로 합치기
            currentQuestions = [];
            
            Object.values(stageData.sentence_variations).forEach(variations => {
                currentQuestions.push(...variations);
            });
            
            // 문제 순서 섞기
            currentQuestions = shuffleArray(currentQuestions);
            
            // 총 문제 수 업데이트
            document.getElementById('total-questions').textContent = currentQuestions.length;
            document.getElementById('remaining').textContent = currentQuestions.length;
            
            // 첫 번째 문제 표시
            showCurrentQuestion();
        }
        
        // 배열 섞기 함수
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // 현재 문제 표시
        function showCurrentQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            
            // 문제 표시
            document.getElementById('korean-question').textContent = question.ko;
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
            
            // 진행 상황 업데이트
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('remaining').textContent = currentQuestions.length - currentQuestionIndex;
            
            const progress = ((currentQuestionIndex) / currentQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            
            // 피드백 숨기기
            document.getElementById('feedback').style.display = 'none';
        }
        
        // 답안 확인
        function checkAnswer() {
            const userAnswer = document.getElementById('answer-input').value.trim().toLowerCase();
            const correctAnswer = currentQuestions[currentQuestionIndex].en.toLowerCase();
            const feedback = document.getElementById('feedback');
            
            totalAttempts++;
            
            // 간단한 답안 검증 (공백과 대소문자 무시, 구두점 허용)
            const normalizeAnswer = (text) => {
                return text.replace(/[.,!?]/g, '').replace(/\s+/g, ' ').trim();
            };
            
            const isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);
            
            if (isCorrect) {
                correctAnswers++;
                feedback.className = 'feedback correct';
                feedback.textContent = '🎉 정답입니다!';
                feedback.style.display = 'block';
                
                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = `❌ 정답: ${currentQuestions[currentQuestionIndex].en}`;
                feedback.style.display = 'block';
                
                setTimeout(() => {
                    nextQuestion();
                }, 2500);
            }
            
            updateStats();
        }
        
        // 다음 문제로
        function nextQuestion() {
            currentQuestionIndex++;
            showCurrentQuestion();
        }
        
        // 넘어가기
        function skipQuestion() {
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback incorrect';
            feedback.textContent = `정답: ${currentQuestions[currentQuestionIndex].en}`;
            feedback.style.display = 'block';
            
            totalAttempts++;
            
            setTimeout(() => {
                nextQuestion();
            }, 2000);
            
            updateStats();
        }
        
        // 힌트 표시
        function showHint() {
            const correctAnswer = currentQuestions[currentQuestionIndex].en;
            const words = correctAnswer.split(' ');
            const hint = words[0] + (words.length > 1 ? ' ...' : '...');
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback';
            feedback.style.background = '#fef3c7';
            feedback.style.color = '#92400e';
            feedback.style.border = '2px solid #f59e0b';
            feedback.textContent = `💡 힌트: ${hint}`;
            feedback.style.display = 'block';
        }
        
        // AI 코칭 기능
        async function showAICoaching() {
            const userAnswer = document.getElementById('answer-input').value.trim();
            const correctAnswer = currentQuestions[currentQuestionIndex].en;
            const koreanQuestion = currentQuestions[currentQuestionIndex].ko;
            const feedback = document.getElementById('feedback');
            
            if (!userAnswer) {
                feedback.className = 'feedback';
                feedback.style.background = '#fff3cd';
                feedback.style.color = '#856404';
                feedback.style.border = '2px solid #ffc107';
                feedback.textContent = '🤖 먼저 답을 입력해주세요!';
                feedback.style.display = 'block';
                return;
            }
            
            // AI 분석 중 표시
            feedback.className = 'feedback';
            feedback.style.background = '#e3f2fd';
            feedback.style.color = '#1565c0';
            feedback.style.border = '2px solid #2196f3';
            feedback.innerHTML = '🤖 AI가 분석 중입니다... <div style="margin-top: 10px;"><div style="width: 20px; height: 20px; border: 2px solid #ccc; border-top: 2px solid #1565c0; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div></div>';
            feedback.style.display = 'block';
            
            try {
                // AI 피드백 생성
                const aiResponse = await getAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData);
                
                feedback.className = 'feedback';
                feedback.style.background = '#f3e5f5';
                feedback.style.color = '#7b1fa2';
                feedback.style.border = '2px solid #9c27b0';
                feedback.innerHTML = aiResponse;
                feedback.style.display = 'block';
                
            } catch (error) {
                console.error('AI 피드백 생성 실패:', error);
                feedback.className = 'feedback';
                feedback.style.background = '#ffebee';
                feedback.style.color = '#c62828';
                feedback.style.border = '2px solid #f44336';
                feedback.textContent = '🤖 AI 서비스에 일시적 문제가 있습니다. 잠시 후 다시 시도해주세요.';
                feedback.style.display = 'block';
            }
        }
        
        // AI 피드백 생성 함수
        async function getAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData) {
            // Google Gemini API를 사용한 AI 피드백 생성
            const apiKey = 'YOUR_GEMINI_API_KEY'; // 실제 사용 시 환경변수로 관리
            
            if (apiKey === 'YOUR_GEMINI_API_KEY') {
                // API 키가 설정되지 않은 경우 시뮬레이션
                return generateMockAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData);
            }
            
            const prompt = `
한국인 영어 학습자를 위한 Level 3 고급 문법 코칭을 해주세요.

**현재 학습 정보:**
- Stage ${stageData.stage}: ${stageData.title}
- Phase ${stageData.phase} (${stageData.grammar_focus})
- 문법 패턴: ${stageData.patterns.join(', ')}

**문제 상황:**
- 한국어 문장: "${koreanQuestion}"
- 정답: "${correctAnswer}"
- 사용자 답변: "${userAnswer}"

**요청사항:**
1. 사용자 답변과 정답의 차이점 분석
2. 문법 패턴 관점에서 교정 포인트 제시
3. 한국인이 자주 하는 실수 패턴이라면 구체적 설명
4. 암기하기 쉬운 팁이나 연상법 제안
5. 격려의 메시지 포함

**응답 형식:** 
🎯 **분석**: [간단한 차이점 분석]
📚 **문법 포인트**: [핵심 문법 설명]  
💡 **한국인 특화 팁**: [한국어-영어 차이 기반 조언]
✨ **기억법**: [암기 팁]
🔥 **격려**: [동기부여 메시지]

간결하고 친근하게, 300자 이내로 답변해주세요.
            `;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
                
            } catch (error) {
                console.error('Gemini API 호출 실패:', error);
                return generateMockAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData);
            }
        }
        
        // 모의 AI 피드백 생성 (API 키 없을 때)
        function generateMockAIFeedback(userAnswer, correctAnswer, koreanQuestion, stageData) {
            const isCorrect = userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim();
            
            if (isCorrect) {
                return `
🎯 **완벽합니다!** "${userAnswer}" 정확한 답변이에요!<br><br>
📚 **문법 포인트**: ${stageData.patterns[0]}을 정확히 적용했네요.<br>
💡 **한국인 특화 팁**: 이 패턴은 ${stageData.grammar_focus}의 핵심입니다.<br>
✨ **기억법**: 패턴 구조를 몸에 익혔네요, 계속 이 조자로!<br>
🔥 **격려**: 고급 문법을 정확히 사용하고 있어요. 실력이 늘고 있습니다! 💪
                `;
            }
            
            const differences = findKeyDifferences(userAnswer, correctAnswer);
            const grammarTip = getGrammarTip(stageData);
            const memoryTip = getMemoryTip(stageData, correctAnswer);
            
            return `
🎯 **분석**: ${differences}<br><br>
📚 **문법 포인트**: ${grammarTip}<br>
💡 **한국인 특화 팁**: "${correctAnswer}" 어순에 주의하세요!<br>
✨ **기억법**: ${memoryTip}<br>
🔥 **격려**: 고급 패턴은 연습이 필요해요. 포기하지 마세요! 🌟
            `;
        }
        
        // 답변 차이점 분석
        function findKeyDifferences(userAnswer, correctAnswer) {
            if (!userAnswer) return "답변을 입력해주세요.";
            
            const userWords = userAnswer.toLowerCase().trim().split(/\s+/);
            const correctWords = correctAnswer.toLowerCase().trim().split(/\s+/);
            
            if (userWords.length !== correctWords.length) {
                return `단어 개수가 다릅니다 (입력: ${userWords.length}개, 정답: ${correctWords.length}개)`;
            }
            
            for (let i = 0; i < correctWords.length; i++) {
                if (userWords[i] !== correctWords[i]) {
                    return `"${userWords[i]}" → "${correctWords[i]}"로 수정 필요`;
                }
            }
            
            return "거의 정확하지만 세부사항을 확인해보세요.";
        }
        
        // 문법 팁 생성
        function getGrammarTip(stageData) {
            const tips = {
                1: "미래 표현: 계획(be going to) vs 즉석결정(will) 구분이 핵심",
                2: "현재완료: 경험(ever/never)과 완료(just) 용법 차이",
                3: "현재완료 계속: for(기간) vs since(시점) 구분",
                4: "과거완료: 과거보다 더 이전 시점 표현 (had + p.p.)",
                5: "수동태 기본: be동사 + 과거분사 구조",
                6: "수동태 심화: 조동사와 수동태 결합",
                7: "조동사: would(완곡), could(가능), might(추측) 뉘앙스",
                8: "조동사 과거: should have(후회), could have(가능성) 표현",
                9: "조건문: 1형식(현실) vs 2형식(가정) 구분",
                10: "가정법 과거: If I were you 패턴으로 조언",
                11: "가정법 과거완료: 과거에 대한 후회 표현"
            };
            return tips[stageData.stage] || `${stageData.title}의 핵심 문법 구조를 확인하세요.`;
        }
        
        // 기억법 팁 생성
        function getMemoryTip(stageData, correctAnswer) {
            const patterns = [
                "어순을 소리 내어 반복해보세요: " + correctAnswer,
                "첫 단어부터 차례대로 기억하세요: " + correctAnswer.split(' ')[0] + "...",
                "문장을 3번 큰 소리로 읽어보세요!",
                "패턴 구조를 몸에 익히는 게 중요해요.",
                "비슷한 문장을 5개 더 만들어보세요!"
            ];
            
            return patterns[Math.floor(Math.random() * patterns.length)];
        }
        
        // 통계 업데이트
        function updateStats() {
            document.getElementById('correct-count').textContent = correctAnswers;
            
            const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }
        
        // 결과 표시
        function showResults() {
            const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
            
            alert(`
🎉 Stage ${stageNumber} 완료!

📊 결과:
• 정답: ${correctAnswers}/${totalAttempts}
• 정확도: ${accuracy}%
• 패턴: ${stageData.title}

${accuracy >= 85 ? '✅ 목표 달성!' : '📚 더 연습이 필요합니다.'}
            `);
            
            // 메인 화면으로 돌아가기
            window.location.href = 'level-system.html';
        }
        
        // 이벤트 리스너
        document.getElementById('check-btn').addEventListener('click', checkAnswer);
        document.getElementById('skip-btn').addEventListener('click', skipQuestion);
        document.getElementById('hint-btn').addEventListener('click', showHint);
        document.getElementById('ai-btn').addEventListener('click', showAICoaching);
        
        // Enter 키로 답안 확인
        document.getElementById('answer-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        // 초기화
        loadLevel3Data();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºì‹± ì „ëµ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .result { padding: 5px 0; }
        .cache-hit { color: green; font-weight: bold; }
        .cache-miss { color: orange; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .performance { background: #e8f4f8; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ìºì‹± ì „ëµ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h3>ğŸš€ 1. TTS ìºì‹œ í…ŒìŠ¤íŠ¸</h3>
        <p>ë™ì¼í•œ í…ìŠ¤íŠ¸+ë³´ì´ìŠ¤ë¡œ ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•˜ì—¬ ìºì‹œ íš¨ê³¼ í™•ì¸</p>
        <button onclick="testTTSCache()">TTS ìºì‹œ í…ŒìŠ¤íŠ¸</button>
        <div id="tts-results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ’¾ 2. Firestore ìºì‹œ í…ŒìŠ¤íŠ¸</h3>
        <p>content serviceì˜ ë ˆë²¨/íŒ¨í„´ ìºì‹œ íš¨ê³¼ í™•ì¸</p>
        <button onclick="testFirestoreCache()">Firestore ìºì‹œ í…ŒìŠ¤íŠ¸</button>
        <div id="firestore-results"></div>
    </div>
    
    <div class="test-section">
        <h3>âš¡ 3. ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸</h3>
        <p>ìºì‹œ íˆíŠ¸ vs ìºì‹œ ë¯¸ìŠ¤ ì‘ë‹µ ì‹œê°„ ë¹„êµ</p>
        <button onclick="testPerformance()">ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</button>
        <div id="performance-results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ”„ 4. í†µí•© ìŠ¤íŠ¸ë¦¬ë° + ìºì‹± í…ŒìŠ¤íŠ¸</h3>
        <p>ë™ì¼í•œ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ë°˜ë³µ ì‹œ ìºì‹œ ì ìš© í™•ì¸</p>
        <button onclick="testStreamingWithCache()">ìŠ¤íŠ¸ë¦¬ë°+ìºì‹± í…ŒìŠ¤íŠ¸</button>
        <div id="streaming-results"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_BASE = 'http://localhost:8088/api';
        
        function addResult(containerId, message, className = '') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${className}`;
            resultDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(resultDiv);
        }
        
        async function testTTSCache() {
            const container = document.getElementById('tts-results');
            container.innerHTML = '';
            
            addResult('tts-results', 'ğŸ”„ TTS ìºì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            const testText = "Hello, this is a test for TTS caching.";
            const voice = "female";
            
            // 1ì°¨ ìš”ì²­ (ìºì‹œ ë¯¸ìŠ¤ ì˜ˆìƒ)
            const start1 = Date.now();
            try {
                const socket1 = io('/realtime');
                
                socket1.on('connect', () => {
                    addResult('tts-results', 'ì²« ë²ˆì§¸ ìš”ì²­ (ìºì‹œ ë¯¸ìŠ¤ ì˜ˆìƒ)...', 'cache-miss');
                    socket1.emit('stt_llm_tts', { audioBlob: 'test', voice, prompt: testText });
                });
                
                socket1.on('stage', (data) => {
                    if (data.step === 'TTS_DONE') {
                        const time1 = Date.now() - start1;
                        addResult('tts-results', `âœ… ì²« ë²ˆì§¸ ìš”ì²­ ì™„ë£Œ: ${time1}ms`, 'cache-miss');
                        socket1.disconnect();
                        
                        // 2ì°¨ ìš”ì²­ (ìºì‹œ íˆíŠ¸ ì˜ˆìƒ)
                        setTimeout(() => {
                            const start2 = Date.now();
                            const socket2 = io('/realtime');
                            
                            socket2.on('connect', () => {
                                addResult('tts-results', 'ë‘ ë²ˆì§¸ ìš”ì²­ (ìºì‹œ íˆíŠ¸ ì˜ˆìƒ)...', 'cache-hit');
                                socket2.emit('stt_llm_tts', { audioBlob: 'test', voice, prompt: testText });
                            });
                            
                            socket2.on('stage', (data) => {
                                if (data.step === 'TTS_DONE') {
                                    const time2 = Date.now() - start2;
                                    addResult('tts-results', `âœ… ë‘ ë²ˆì§¸ ìš”ì²­ ì™„ë£Œ: ${time2}ms`, 'cache-hit');
                                    addResult('tts-results', `ğŸ“Š ì„±ëŠ¥ ê°œì„ : ${Math.round((1 - time2/time1) * 100)}%`, 'performance');
                                    socket2.disconnect();
                                }
                            });
                        }, 1000);
                    }
                });
                
            } catch (error) {
                addResult('tts-results', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testFirestoreCache() {
            const container = document.getElementById('firestore-results');
            container.innerHTML = '';
            
            addResult('firestore-results', 'ğŸ”„ Firestore ìºì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë ˆë²¨IDë¡œ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì ì ˆí•œ ID ì‚¬ìš©)
            const testLevelId = 'test-level';
            
            try {
                // 1ì°¨ ìš”ì²­
                const start1 = Date.now();
                const response1 = await fetch(`${API_BASE}/content/level/${testLevelId}`);
                const time1 = Date.now() - start1;
                addResult('firestore-results', `ì²« ë²ˆì§¸ ë ˆë²¨ ì¡°íšŒ: ${time1}ms`, 'cache-miss');
                
                // 2ì°¨ ìš”ì²­ (ìºì‹œì—ì„œ ì¡°íšŒ ì˜ˆìƒ)
                const start2 = Date.now();
                const response2 = await fetch(`${API_BASE}/content/level/${testLevelId}`);
                const time2 = Date.now() - start2;
                addResult('firestore-results', `ë‘ ë²ˆì§¸ ë ˆë²¨ ì¡°íšŒ: ${time2}ms`, 'cache-hit');
                
                if (time1 > time2) {
                    addResult('firestore-results', `ğŸ“Š ìºì‹œ íš¨ê³¼ í™•ì¸: ${Math.round((1 - time2/time1) * 100)}% ê°œì„ `, 'performance');
                } else {
                    addResult('firestore-results', `âš ï¸ ìºì‹œ íš¨ê³¼ ë¯¸ë¯¸ ë˜ëŠ” ì„œë²„ ìƒíƒœ í™•ì¸ í•„ìš”`, 'cache-miss');
                }
                
            } catch (error) {
                addResult('firestore-results', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testPerformance() {
            const container = document.getElementById('performance-results');
            container.innerHTML = '';
            
            addResult('performance-results', 'âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            const performances = {
                cacheMiss: [],
                cacheHit: []
            };
            
            // ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•˜ì—¬ í‰ê·  ì„±ëŠ¥ ì¸¡ì •
            for (let i = 0; i < 3; i++) {
                try {
                    const uniqueText = `Performance test ${Date.now()}_${i}`;
                    
                    // ìºì‹œ ë¯¸ìŠ¤ ì¸¡ì •
                    const socket = io('/realtime');
                    const startTime = Date.now();
                    
                    await new Promise((resolve) => {
                        socket.on('connect', () => {
                            socket.emit('stt_llm_tts', { 
                                audioBlob: 'test', 
                                voice: 'female', 
                                prompt: uniqueText 
                            });
                        });
                        
                        socket.on('complete', () => {
                            const duration = Date.now() - startTime;
                            performances.cacheMiss.push(duration);
                            socket.disconnect();
                            resolve();
                        });
                    });
                    
                } catch (error) {
                    addResult('performance-results', `âŒ ì˜¤ë¥˜ ${i}: ${error.message}`, 'error');
                }
            }
            
            // ê²°ê³¼ ê³„ì‚°
            const avgCacheMiss = performances.cacheMiss.reduce((a, b) => a + b, 0) / performances.cacheMiss.length;
            
            addResult('performance-results', `ğŸ“Š ìºì‹œ ë¯¸ìŠ¤ í‰ê· : ${Math.round(avgCacheMiss)}ms`, 'cache-miss');
            addResult('performance-results', `ğŸ“ˆ ì´ ìš”ì²­ ìˆ˜: ${performances.cacheMiss.length}ê°œ`, 'performance');
        }
        
        async function testStreamingWithCache() {
            const container = document.getElementById('streaming-results');
            container.innerHTML = '';
            
            addResult('streaming-results', 'ğŸ”„ ìŠ¤íŠ¸ë¦¬ë°+ìºì‹± í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            const testData = {
                audioBlob: 'streaming_test',
                voice: 'female',
                prompt: 'Streaming with caching test'
            };
            
            // ì²« ë²ˆì§¸ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­
            const socket1 = io('/realtime');
            const start1 = Date.now();
            
            socket1.on('connect', () => {
                addResult('streaming-results', 'ğŸš€ ì²« ë²ˆì§¸ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘...', 'cache-miss');
                socket1.emit('stt_llm_tts', testData);
            });
            
            socket1.on('stage', (data) => {
                addResult('streaming-results', `${data.step}: ${JSON.stringify(data).slice(0, 100)}...`);
            });
            
            socket1.on('complete', () => {
                const time1 = Date.now() - start1;
                addResult('streaming-results', `âœ… ì²« ë²ˆì§¸ ì™„ë£Œ: ${time1}ms`, 'cache-miss');
                socket1.disconnect();
                
                // ë‘ ë²ˆì§¸ ë™ì¼í•œ ìš”ì²­
                setTimeout(() => {
                    const socket2 = io('/realtime');
                    const start2 = Date.now();
                    
                    socket2.on('connect', () => {
                        addResult('streaming-results', 'ğŸš€ ë‘ ë²ˆì§¸ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ (ìºì‹œ íš¨ê³¼ ê¸°ëŒ€)...', 'cache-hit');
                        socket2.emit('stt_llm_tts', testData);
                    });
                    
                    socket2.on('stage', (data) => {
                        addResult('streaming-results', `${data.step} (cached): ${JSON.stringify(data).slice(0, 100)}...`);
                    });
                    
                    socket2.on('complete', () => {
                        const time2 = Date.now() - start2;
                        addResult('streaming-results', `âœ… ë‘ ë²ˆì§¸ ì™„ë£Œ: ${time2}ms`, 'cache-hit');
                        addResult('streaming-results', `ğŸ“Š ìŠ¤íŠ¸ë¦¬ë° ì„±ëŠ¥ ê°œì„ : ${Math.round((1 - time2/time1) * 100)}%`, 'performance');
                        socket2.disconnect();
                    });
                }, 1500);
            });
        }
    </script>
</body>
</html>
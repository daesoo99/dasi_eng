<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASI English - Level System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4338ca, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* 레벨 선택 화면 */
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        .level-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .level-card.unlocked {
            border-color: #10b981;
        }
        .level-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
            background: linear-gradient(135deg, #f1f5f9, #cbd5e1);
        }
        .level-card.completed {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
        }
        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .level-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #1f2937;
        }
        .level-icon {
            font-size: 2em;
        }
        .level-progress {
            background: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .level-progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .level-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #64748b;
        }
        .level-description {
            font-size: 0.9em;
            color: #64748b;
            margin-top: 10px;
        }

        /* 스테이지 상세 화면 */
        .stage-view {
            display: none;
            padding: 30px;
        }
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .back-btn:hover {
            background: #4b5563;
        }
        .stage-title {
            font-size: 2em;
            color: #1f2937;
        }
        .stage-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            justify-items: center;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
            padding: 30px 20px;
            background: #f8fafc;
            border-radius: 15px;
            max-width: 100%;
        }
        
        /* Level 2 (20개) - 10열 그리드 */
        .stage-steps.level-2 {
            grid-template-columns: repeat(10, 1fr);
            max-width: 800px;
            margin: 30px auto;
        }
        
        /* Level 3 (30개) - 10열 그리드 */  
        .stage-steps.level-3 {
            grid-template-columns: repeat(10, 1fr);
            max-width: 900px;
            margin: 30px auto;
        }
        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .step.all-step {
            width: 60px;
            height: 60px;
            font-size: 12px;
            font-weight: bold;
        }
        .step.completed {
            background: #10b981;
            color: white;
        }
        .step.current {
            background: #3b82f6;
            color: white;
            animation: pulse 2s infinite;
        }
        .step.locked {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .stage-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .info-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
        }
        .info-card h3 {
            color: #1f2937;
            margin-bottom: 10px;
        }
        .info-card p {
            color: #64748b;
        }
        .stage-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        .start-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .stats-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 개발자/일반 모드 토글 */
        .mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 8px 15px;
            backdrop-filter: blur(10px);
            z-index: 10000;
        }
        .mode-label {
            color: white;
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        .mode-label.active {
            opacity: 1;
            font-weight: bold;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255,255,255,0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #10b981;
        }
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        .dev-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        .dev-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <!-- 모드 토글 -->
            <div class="mode-toggle">
                <span class="mode-label active" id="normal-label">일반</span>
                <div class="toggle-switch" id="toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
                <span class="mode-label" id="dev-label">개발자</span>
                <div class="dev-indicator" id="dev-indicator">DEV</div>
            </div>

            <h1>🎯 DASI English</h1>
            <p>Do you vs Are you 완전 정복 - 10레벨 시스템</p>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-number" id="user-level">1</div>
                    <div class="stat-label">현재 레벨</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-progress">5%</div>
                    <div class="stat-label">전체 진행률</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracy">85%</div>
                    <div class="stat-label">평균 정확도</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-mistakes">0</div>
                    <div class="stat-label">틀린 문제</div>
                </div>
                <div class="stat-item review-stat" style="position: relative;">
                    <div class="stat-number" id="due-reviews">0</div>
                    <div class="stat-label">복습 대기</div>
                    <div id="review-badge" class="review-badge" style="display: none; position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold;">
                        NEW
                    </div>
                </div>
            </div>
            
            <!-- 복습 알림 버튼 -->
            <div style="display: flex; justify-content: center; margin-top: 20px; gap: 15px;">
                <button id="review-btn" class="review-btn" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); transition: all 0.3s;">
                    📖 복습하기 (<span id="review-count">0</span>개)
                </button>
                <button id="stats-btn" class="stats-btn" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s;">
                    📊 학습 통계
                </button>
                <button id="forgetting-curve-btn" class="forgetting-curve-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); transition: all 0.3s;">
                    🧠 망각곡선 현황
                </button>
            </div>
        </div>

        <!-- 레벨 선택 화면 -->
        <div class="levels-view" id="levels-view">
            <div class="levels-grid" id="levels-grid">
                <!-- 레벨 카드들이 여기에 생성됩니다 -->
            </div>
        </div>

        <!-- 복습 모드 화면 -->
        <div class="review-view" id="review-view" style="display: none; padding: 30px;">
            <div class="stage-header">
                <button class="back-btn" id="back-from-review-btn">
                    ← 메인으로 돌아가기
                </button>
                <div class="stage-title">📖 복습 모드</div>
                <div></div>
            </div>
            
            <div style="background: #fef3c7; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: #92400e; margin: 0 0 15px 0;">🧠 망각곡선 복습 시스템</h3>
                <p style="color: #d97706; margin: 0; line-height: 1.6;">
                    틀린 문제들을 과학적 복습 주기로 반복 학습합니다.<br>
                    <strong>1일 → 3일 → 7일 → 14일</strong> 간격으로 복습하여 장기 기억에 저장됩니다.
                </p>
            </div>
            
            <div id="review-content">
                <!-- 복습 문제들이 여기에 표시됩니다 -->
            </div>
        </div>
        
        <!-- 통계 모드 화면 -->
        <div class="stats-view" id="stats-view" style="display: none; padding: 30px;">
            <div class="stage-header">
                <button class="back-btn" id="back-from-stats-btn">
                    ← 메인으로 돌아가기
                </button>
                <div class="stage-title">📊 학습 통계 대시보드</div>
                <div></div>
            </div>
            
            <div id="stats-content">
                <!-- 통계 정보가 여기에 표시됩니다 -->
            </div>
        </div>
        
        <!-- 망각곡선 현황 화면 -->
        <div class="forgetting-curve-view" id="forgetting-curve-view" style="display: none; padding: 30px;">
            <div class="stage-header">
                <button class="back-btn" id="back-from-curve-btn">
                    ← 메인으로 돌아가기
                </button>
                <div class="stage-title">🧠 망각곡선 상세 현황</div>
                <div></div>
            </div>
            
            <div id="curve-content">
                <!-- 망각곡선 정보가 여기에 표시됩니다 -->
            </div>
        </div>

        <!-- 스테이지 상세 화면 -->
        <div class="stage-view" id="stage-view" style="display: none;">
            <div class="stage-header">
                <button class="back-btn" id="back-btn">
                    ← 레벨 선택으로
                </button>
                <div class="stage-title" id="stage-title">Level 1 - 기초 동사</div>
                <div></div>
            </div>

            <div class="stage-steps" id="stage-steps">
                <!-- 스테이지 스텝들이 여기에 생성됩니다 -->
            </div>

            <div class="stage-info">
                <div class="info-card">
                    <h3>🎯 학습 동사</h3>
                    <p id="stage-verbs">go, have, like</p>
                </div>
                <div class="info-card">
                    <h3>📝 학습 패턴</h3>
                    <p>I go, I don't go, Do you go?<br>I'm going, I'm not going, Are you going?</p>
                </div>
                <div class="info-card">
                    <h3>🎯 목표</h3>
                    <p id="stage-target">정확도 80% 이상<br>평균 반응속도 3.0초 이내</p>
                </div>
                <div class="info-card">
                    <h3>📊 현재 성과</h3>
                    <p id="stage-current">정확도: 0%<br>최고 기록: 0%<br>시도 횟수: 0</p>
                </div>
            </div>

            <div class="stage-actions">
                <button class="action-btn start-btn" id="start-stage-btn">
                    🚀 스테이지 시작
                </button>
                <button class="action-btn stats-btn" id="stage-stats-btn">
                    📊 상세 통계
                </button>
            </div>
        </div>
    </div>

    <script>
        // 레벨 데이터 정의
        const levelData = [
            {
                level: 1,
                title: "구조 패턴 중심 (19 스테이지)",
                description: "영어 문장의 기본 뼈대를 단계별로 습득",
                verbs: ["Be동사", "일반동사", "부정문", "의문문", "기초확장"],
                targetAccuracy: 80,
                targetSpeed: 3.0,
                stages: 19,
                stageVerbs: {
                    1: ["Be동사 현재"], 2: ["Be동사 과거"], 3: ["Be동사 미래"],
                    4: ["일반동사 현재"], 5: ["일반동사 과거"], 6: ["일반동사 미래"],
                    7: ["Be동사 부정"], 8: ["일반동사 부정"],
                    9: ["Be동사 의문문"], 10: ["일반동사 의문문"], 11: ["Wh- 질문"],
                    12: ["There is/are"], 13: ["I like"], 14: ["I have"], 15: ["I want to"],
                    16: ["at/in/on 전치사"], 17: ["a/an/the 관사"], 18: ["This/That"], 19: ["Please/Can you"]
                }
            },
            {
                level: 2,
                title: "기본 문법 패턴",
                description: "be동사, 일반동사, 조동사의 기본 패턴 습득",
                verbs: ["be동사", "일반동사", "조동사", "현재진행형", "과거형", "미래형"],
                targetAccuracy: 80,
                targetSpeed: 2.5,
                stages: 20,
                stageVerbs: {
                    1: ["be동사 현재형 (긍정문)"],
                    2: ["be동사 현재형 (부정문)"],
                    3: ["be동사 현재형 (의문문)"],
                    4: ["일반동사 현재형 (긍정문)"],
                    5: ["일반동사 현재형 (부정문)"],
                    6: ["일반동사 현재형 (의문문)"],
                    7: ["현재진행형 (긍정문)"],
                    8: ["현재진행형 (부정문)"],
                    9: ["현재진행형 (의문문)"],
                    10: ["can 조동사 (긍정문)"],
                    11: ["can 조동사 (부정문)"],
                    12: ["can 조동사 (의문문)"],
                    13: ["과거형 (긍정문)"],
                    14: ["과거형 (부정문)"],
                    15: ["과거형 (의문문)"],
                    16: ["will 미래형 (긍정문)"],
                    17: ["will 미래형 (부정문)"],
                    18: ["will 미래형 (의문문)"],
                    19: ["have to 의무형"],
                    20: ["종합 복습 및 비교급"]
                }
            },
            {
                level: 3,
                title: "시제·태·논리 확장 패턴",
                description: "복합 시제, 조동사, 관계절, 논리 연결의 고급 문법 패턴",
                verbs: ["미래형심화", "현재완료", "과거완료", "수동태", "조동사확장", "조건문", "가정법"],
                targetAccuracy: 85,
                targetSpeed: 2.0,
                stages: 30,
                stageVerbs: {
                    1: ["미래형 심화 (will vs be going to)"],
                    2: ["현재완료 경험·완료 용법"],
                    3: ["현재완료 결과·계속 + 시간표현"],
                    4: ["과거완료·과거완료진행형"],
                    5: ["수동태 기본 (be + p.p.)"],
                    6: ["수동태 심화 (조동사 + 수동태)"],
                    7: ["조동사 확장 1 (would, could, might)"],
                    8: ["조동사 확장 2 (should have, could have)"],
                    9: ["조건문 기본 (1형식, 2형식)"],
                    10: ["가정법 과거 (If I were you)"],
                    11: ["가정법 과거완료 (If I had known)"]
                }
            },
            {
                level: 4,
                title: "거래 동사",
                description: "진행형/부정/의문 혼합 + 1초 도전 일부",
                verbs: ["buy", "sell", "use", "try", "find"],
                targetAccuracy: 85,
                targetSpeed: 2.0,
                stages: 10,
                stageVerbs: {
                    1: ["buy"], 2: ["sell"], 3: ["use"], 4: ["try"], 5: ["find"],
                    6: ["buy", "sell"], 7: ["use", "try"], 8: ["find", "buy"], 9: ["sell", "use"], 10: ["buy", "sell", "use", "try", "find"]
                }
            },
            {
                level: 5,
                title: "소통 동사",
                description: "3인칭 단수/과거 혼합 패턴",
                verbs: ["give", "tell", "show", "meet", "help"],
                targetAccuracy: 88,
                targetSpeed: 1.5,
                stages: 10,
                stageVerbs: {
                    1: ["give"], 2: ["tell"], 3: ["show"], 4: ["meet"], 5: ["help"],
                    6: ["give", "tell"], 7: ["show", "meet"], 8: ["help", "give"], 9: ["tell", "show"], 10: ["give", "tell", "show", "meet", "help"]
                }
            },
            {
                level: 6,
                title: "행동 동사",
                description: "시제 전환 속도 증가",
                verbs: ["come", "leave", "start", "finish", "plan"],
                targetAccuracy: 88,
                targetSpeed: 1.5,
                stages: 10,
                stageVerbs: {
                    1: ["come"], 2: ["leave"], 3: ["start"], 4: ["finish"], 5: ["plan"],
                    6: ["come", "leave"], 7: ["start", "finish"], 8: ["plan", "come"], 9: ["leave", "start"], 10: ["come", "leave", "start", "finish", "plan"]
                }
            },
            {
                level: 7,
                title: "선택 동사",
                description: "이유/의견 연결 패턴",
                verbs: ["choose", "decide", "prefer", "expect", "suppose"],
                targetAccuracy: 90,
                targetSpeed: 1.2,
                stages: 10,
                stageVerbs: {
                    1: ["choose"], 2: ["decide"], 3: ["prefer"], 4: ["expect"], 5: ["suppose"],
                    6: ["choose", "decide"], 7: ["prefer", "expect"], 8: ["suppose", "choose"], 9: ["decide", "prefer"], 10: ["choose", "decide", "prefer", "expect", "suppose"]
                }
            },
            {
                level: 8,
                title: "허용 동사",
                description: "let/make, to부정사 패턴 확장",
                verbs: ["keep", "let", "allow", "suggest", "recommend"],
                targetAccuracy: 90,
                targetSpeed: 1.2,
                stages: 10,
                stageVerbs: {
                    1: ["keep"], 2: ["let"], 3: ["allow"], 4: ["suggest"], 5: ["recommend"],
                    6: ["keep", "let"], 7: ["allow", "suggest"], 8: ["recommend", "keep"], 9: ["let", "allow"], 10: ["keep", "let", "allow", "suggest", "recommend"]
                }
            },
            {
                level: 9,
                title: "전문 동사",
                description: "추상/업무형 단어 혼입",
                verbs: ["improve", "reduce", "compare", "analyze", "design"],
                targetAccuracy: 92,
                targetSpeed: 1.0,
                stages: 10,
                stageVerbs: {
                    1: ["improve"], 2: ["reduce"], 3: ["compare"], 4: ["analyze"], 5: ["design"],
                    6: ["improve", "reduce"], 7: ["compare", "analyze"], 8: ["design", "improve"], 9: ["reduce", "compare"], 10: ["improve", "reduce", "compare", "analyze", "design"]
                }
            },
            {
                level: 10,
                title: "고급 동사",
                description: "고난도 조합 패턴",
                verbs: ["coordinate", "negotiate", "prioritize", "implement", "evaluate"],
                targetAccuracy: 95,
                targetSpeed: 1.0,
                stages: 10,
                stageVerbs: {
                    1: ["coordinate"], 2: ["negotiate"], 3: ["prioritize"], 4: ["implement"], 5: ["evaluate"],
                    6: ["coordinate", "negotiate"], 7: ["prioritize", "implement"], 8: ["evaluate", "coordinate"], 9: ["negotiate", "prioritize"], 10: ["coordinate", "negotiate", "prioritize", "implement", "evaluate"]
                }
            }
        ];

        // 사용자 진행 상황 (임시 데이터)
        let userProgress = {
            currentLevel: 1,
            levels: [
                { 
                    level: 1, 
                    completed: false, 
                    progress: 0, 
                    bestAccuracy: 0, 
                    attempts: 0,
                    stages: [
                        { stage: 1, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 2, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 3, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 4, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 5, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 6, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 7, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 8, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 9, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 10, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 11, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 12, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 13, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 14, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 15, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 16, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 17, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 18, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 19, completed: false, accuracy: 0, attempts: 0 }
                    ]
                },
                { 
                    level: 2, 
                    completed: false, 
                    progress: 15, 
                    bestAccuracy: 85, 
                    attempts: 6,
                    stages: [
                        { stage: 1, completed: true, accuracy: 82, attempts: 2 },
                        { stage: 2, completed: true, accuracy: 88, attempts: 1 },
                        { stage: 3, completed: true, accuracy: 85, attempts: 3 },
                        { stage: 4, completed: false, accuracy: 75, attempts: 2 },
                        { stage: 5, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 6, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 7, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 8, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 9, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 10, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 11, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 12, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 13, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 14, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 15, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 16, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 17, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 18, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 19, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 20, completed: false, accuracy: 0, attempts: 0 }
                    ]
                },
                { 
                    level: 3, 
                    completed: false, 
                    progress: 0, 
                    bestAccuracy: 0, 
                    attempts: 0,
                    stages: [
                        { stage: 1, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 2, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 3, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 4, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 5, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 6, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 7, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 8, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 9, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 10, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 11, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 12, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 13, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 14, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 15, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 16, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 17, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 18, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 19, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 20, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 21, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 22, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 23, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 24, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 25, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 26, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 27, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 28, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 29, completed: false, accuracy: 0, attempts: 0 },
                        { stage: 30, completed: false, accuracy: 0, attempts: 0 }
                    ]
                }
            ]
        };

        // 개발자 모드 상태
        let isDeveloperMode = false;

        // DOM 요소
        const levelsView = document.getElementById('levels-view');
        const stageView = document.getElementById('stage-view');
        const reviewView = document.getElementById('review-view');
        const statsView = document.getElementById('stats-view');
        const forgettingCurveView = document.getElementById('forgetting-curve-view');
        const levelsGrid = document.getElementById('levels-grid');
        const backBtn = document.getElementById('back-btn');
        const backFromReviewBtn = document.getElementById('back-from-review-btn');
        const backFromStatsBtn = document.getElementById('back-from-stats-btn');
        const backFromCurveBtn = document.getElementById('back-from-curve-btn');
        const reviewBtn = document.getElementById('review-btn');
        const statsBtn = document.getElementById('stats-btn');
        const forgettingCurveBtn = document.getElementById('forgetting-curve-btn');

        let currentViewLevel = null;
        let selectedStage = null;

        // localStorage 연동 (pattern-training.html과 동일한 구조)
        const STORAGE_KEYS = {
            MISTAKES: 'dasi_mistakes',
            USER_STATS: 'dasi_user_stats'
        };

        const StorageManager = {
            getMistakes() {
                try {
                    const data = localStorage.getItem(STORAGE_KEYS.MISTAKES);
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('틀린 문제 데이터 로드 실패:', error);
                    return [];
                }
            },

            getDueReviews() {
                const now = Date.now();
                const mistakes = this.getMistakes();
                return mistakes.filter(mistake => 
                    !mistake.mastered && mistake.nextReview <= now
                );
            },

            getUserStats() {
                try {
                    const data = localStorage.getItem(STORAGE_KEYS.USER_STATS);
                    return data ? JSON.parse(data) : {
                        totalSessions: 0,
                        totalQuestions: 0,
                        totalCorrect: 0,
                        totalMistakes: 0,
                        averageAccuracy: 0,
                        totalStudyTime: 0
                    };
                } catch (error) {
                    console.error('사용자 통계 로드 실패:', error);
                    return {};
                }
            },

            // 테스트용: 시간 가속 (개발자 모드)
            accelerateTimeForTesting() {
                const mistakes = this.getMistakes();
                const now = Date.now();
                
                mistakes.forEach(mistake => {
                    if (!mistake.mastered) {
                        // 모든 복습 시간을 현재 시간보다 과거로 설정
                        mistake.nextReview = now - Math.random() * 1000;
                    }
                });
                
                localStorage.setItem(STORAGE_KEYS.MISTAKES, JSON.stringify(mistakes));
                console.log('⚡ 시간 가속 완료: 모든 문제가 복습 대상이 됩니다.');
            },

            // 테스트용: 가짜 틀린 문제 생성
            generateTestMistakes() {
                const testMistakes = [
                    {
                        id: 'test_1',
                        level: 1, stage: 1,
                        korean: '나는 간다', english: 'I go',
                        verb: 'go', pattern: 'present_simple_positive',
                        mistakeCount: 2, reviewStage: 0,
                        nextReview: Date.now() - 1000,
                        mastered: false
                    },
                    {
                        id: 'test_2', 
                        level: 1, stage: 2,
                        korean: '나는 안 간다', english: "I don't go",
                        verb: 'go', pattern: 'present_simple_negative',
                        mistakeCount: 1, reviewStage: 1,
                        nextReview: Date.now() - 500,
                        mastered: false
                    },
                    {
                        id: 'test_3',
                        level: 2, stage: 1, 
                        korean: '나는 먹는 중이다', english: "I'm eating",
                        verb: 'eat', pattern: 'present_continuous_positive',
                        mistakeCount: 3, reviewStage: 0,
                        nextReview: Date.now() - 2000,
                        mastered: false
                    }
                ];

                localStorage.setItem(STORAGE_KEYS.MISTAKES, JSON.stringify(testMistakes));
                localStorage.setItem(STORAGE_KEYS.USER_STATS, JSON.stringify({
                    totalSessions: 12,
                    totalQuestions: 85,
                    totalCorrect: 70,
                    totalMistakes: 15,
                    averageAccuracy: 82.4,
                    totalStudyTime: 1800000 // 30분
                }));
                console.log('🧪 테스트 데이터 생성 완료');
            },

            // 시간 차이를 사람이 읽기 쉬운 형태로 변환
            getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                const minute = 60 * 1000;
                const hour = 60 * minute;
                const day = 24 * hour;
                const week = 7 * day;
                
                if (diff < minute) return '방금 전';
                if (diff < hour) return `${Math.floor(diff / minute)}분 전`;
                if (diff < day) return `${Math.floor(diff / hour)}시간 전`;
                if (diff < week) return `${Math.floor(diff / day)}일 전`;
                return `${Math.floor(diff / week)}주 전`;
            },

            // 다음 복습까지 남은 시간
            getTimeUntil(timestamp) {
                const now = Date.now();
                const diff = timestamp - now;
                
                if (diff <= 0) return '복습 가능';
                
                const minute = 60 * 1000;
                const hour = 60 * minute;
                const day = 24 * hour;
                const week = 7 * day;
                
                if (diff < minute) return '곧 복습 가능';
                if (diff < hour) return `${Math.floor(diff / minute)}분 후`;
                if (diff < day) return `${Math.floor(diff / hour)}시간 후`;
                if (diff < week) return `${Math.floor(diff / day)}일 후`;
                return `${Math.floor(diff / week)}주 후`;
            }
        };

        // 레벨 카드 생성
        function createLevelCards() {
            levelsGrid.innerHTML = '';
            
            levelData.forEach(level => {
                const userLevelData = userProgress.levels.find(l => l.level === level.level) || 
                                    { level: level.level, completed: false, progress: 0, bestAccuracy: 0, attempts: 0 };
                
                // 개발자 모드일 때는 모든 레벨 해제, 일반 모드에서는 이전 레벨 완료 시에만 해제
                const isUnlocked = isDeveloperMode || level.level === 1 || 
                                 (userProgress.levels.find(l => l.level === level.level - 1 && l.completed));
                const isCompleted = userLevelData.completed;
                
                const card = document.createElement('div');
                card.className = `level-card ${isCompleted ? 'completed' : (isUnlocked ? 'unlocked' : 'locked')}`;
                
                let icon = '🔒';
                if (isCompleted) icon = '🏆';
                else if (isUnlocked) icon = '⭐';
                
                card.innerHTML = `
                    <div class="level-header">
                        <div class="level-title">Level ${level.level}</div>
                        <div class="level-icon">${icon}</div>
                    </div>
                    <div class="level-progress">
                        <div class="level-progress-fill" style="width: ${userLevelData.progress}%"></div>
                    </div>
                    <div class="level-stats">
                        <span>진행률: ${userLevelData.progress}%</span>
                        <span>최고: ${userLevelData.bestAccuracy}%</span>
                    </div>
                    <h3 style="margin: 10px 0 5px 0; color: #1f2937;">${level.title}</h3>
                    <div class="level-description">${level.description}</div>
                    <div class="level-description" style="margin-top: 10px;">
                        <strong>동사:</strong> ${level.verbs.join(', ')}
                    </div>
                    <div class="level-description">
                        <strong>목표:</strong> 정확도 ${level.targetAccuracy}%
                    </div>
                `;
                
                if (isUnlocked) {
                    card.addEventListener('click', () => showStageView(level.level));
                }
                
                levelsGrid.appendChild(card);
            });
        }

        // 스테이지 뷰 표시
        function showStageView(levelNum) {
            currentViewLevel = levelNum;
            const level = levelData.find(l => l.level === levelNum);
            
            levelsView.style.display = 'none';
            stageView.style.display = 'block';
            
            document.getElementById('stage-title').textContent = `Level ${level.level} - ${level.title}`;
            document.getElementById('stage-verbs').textContent = level.verbs.join(', ');
            document.getElementById('stage-target').innerHTML = 
                `정확도 ${level.targetAccuracy}% 이상`;
            
            createStageSteps(level);
        }

        // 스테이지 스텝 생성
        function createStageSteps(level) {
            const stageSteps = document.getElementById('stage-steps');
            stageSteps.innerHTML = '';
            
            // 레벨에 따른 CSS 클래스 추가
            stageSteps.className = `stage-steps level-${level.level}`;
            
            const userLevelData = userProgress.levels.find(l => l.level === level.level);
            const userStages = userLevelData?.stages || [];
            
            for (let i = 1; i <= level.stages; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.textContent = i;
                
                const stageData = userStages.find(s => s.stage === i);
                
                if (stageData?.completed) {
                    step.classList.add('completed');
                    step.title = `완료됨 - 정확도: ${stageData.accuracy}%, 시도: ${stageData.attempts}번`;
                } else if (isDeveloperMode || i === 1 || (userStages.find(s => s.stage === i - 1)?.completed)) {
                    // 개발자 모드이거나, 첫 번째 스테이지이거나, 이전 스테이지가 완료된 경우
                    if (stageData && stageData.attempts > 0) {
                        step.classList.add('current');
                        step.title = `진행중 - 최고: ${stageData.accuracy}%, 시도: ${stageData.attempts}번`;
                    } else {
                        step.classList.add('current');
                        step.title = '시작 가능';
                    }
                } else {
                    step.classList.add('locked');
                    step.title = '잠금됨 - 이전 스테이지를 완료하세요';
                }
                
                step.addEventListener('click', () => {
                    if (!step.classList.contains('locked')) {
                        selectStage(level.level, i);
                    }
                });
                
                stageSteps.appendChild(step);
            }
            
            // ALL 버튼 추가
            
            const allStep = document.createElement('div');
            allStep.className = 'step all-step';
            allStep.textContent = 'ALL';
            
            // 잠금 상태 확인
            const isAllUnlocked = isDeveloperMode || allStagesCompleted;
            
            if (isAllUnlocked) {
                allStep.title = '레벨 전체 동사 통합 훈련';
                allStep.style.cssText = `
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                    font-weight: bold;
                    width: 50px;
                    font-size: 12px;
                    cursor: pointer;
                `;
                
                allStep.addEventListener('click', () => {
                    selectAllStage(level.level);
                });
            } else {
                allStep.title = '잠금됨 - 모든 스테이지를 완료하세요';
                allStep.classList.add('locked');
                allStep.style.cssText = `
                    background: #e5e7eb;
                    color: #9ca3af;
                    font-weight: bold;
                    width: 50px;
                    font-size: 12px;
                    cursor: not-allowed;
                `;
            }
            
            stageSteps.appendChild(allStep);
        }

        // 스테이지 선택
        function selectStage(levelNum, stageNum) {
            console.log(`Selected Level ${levelNum}, Stage ${stageNum}`);
            
            selectedStage = stageNum; // 선택된 스테이지 저장
            
            const level = levelData.find(l => l.level === levelNum);
            const userLevelData = userProgress.levels.find(l => l.level === levelNum);
            const stageData = userLevelData?.stages?.find(s => s.stage === stageNum);
            
            // 스테이지별 동사 표시
            const stageVerbs = level?.stageVerbs?.[stageNum] || level?.verbs || [];
            document.getElementById('stage-verbs').textContent = stageVerbs.join(', ');
            
            if (stageData) {
                const status = stageData.completed ? '완료' : (stageData.attempts > 0 ? '도전중' : '미시작');
                document.getElementById('stage-current').innerHTML = 
                    `상태: ${status}<br>정확도: ${stageData.accuracy}%<br>시도 횟수: ${stageData.attempts}번`;
            } else {
                document.getElementById('stage-current').innerHTML = 
                    `상태: 미시작<br>정확도: 0%<br>시도 횟수: 0번`;
            }
            
            // 선택된 스테이지 하이라이트
            const allSteps = document.querySelectorAll('.step');
            allSteps.forEach((step, index) => {
                if (index + 1 === stageNum && !step.classList.contains('locked')) {
                    step.style.border = '3px solid #f59e0b';
                } else {
                    step.style.border = 'none';
                }
            });
        }

        // ALL 스테이지 선택 (레벨 전체 통합)
        function selectAllStage(levelNum) {
            const level = levelData.find(l => l.level === levelNum);
            const userLevelData = userProgress.levels.find(l => l.level === levelNum);
            const userStages = userLevelData?.stages || [];
            
            // 모든 스테이지 완료 확인
            const allStagesCompleted = userStages.length === level.stages && 
                                     userStages.every(stage => stage.completed);
            
            if (!isDeveloperMode && !allStagesCompleted) {
                alert('모든 스테이지를 완료해야 ALL 모드를 사용할 수 있습니다!');
                return;
            }
            
            console.log(`Selected Level ${levelNum}, ALL Stages`);
            
            selectedStage = 'ALL'; // ALL로 설정
            
            // 레벨의 모든 동사 표시
            document.getElementById('stage-verbs').textContent = level.verbs.join(', ');
            
            // ALL 스테이지 정보 표시
            document.getElementById('stage-current').innerHTML = 
                `상태: 레벨 통합 훈련<br>모든 동사 혼합 학습<br>최고 난이도`;
            
            // 모든 스텝 선택 해제하고 ALL만 하이라이트
            const allSteps = document.querySelectorAll('.step');
            allSteps.forEach(step => {
                if (step.classList.contains('all-step') && !step.classList.contains('locked')) {
                    step.style.border = '3px solid #f59e0b';
                    step.style.transform = 'scale(1.1)';
                } else {
                    step.style.border = 'none';
                    step.style.transform = 'scale(1)';
                }
            });
        }

        // 뒤로 가기
        backBtn.addEventListener('click', () => {
            levelsView.style.display = 'block';
            stageView.style.display = 'none';
            currentViewLevel = null;
        });

        // 스테이지 시작 버튼
        document.getElementById('start-stage-btn').addEventListener('click', () => {
            if (currentViewLevel && selectedStage) {
                const level = levelData.find(l => l.level === currentViewLevel);
                
                let stageVerbs;
                if (selectedStage === 'ALL') {
                    // ALL 선택 시 레벨의 모든 동사 사용
                    stageVerbs = level.verbs;
                } else {
                    // 일반 스테이지는 기존 로직
                    stageVerbs = level?.stageVerbs?.[selectedStage] || level?.verbs || [];
                }
                
                // 레벨별 적절한 연습 페이지로 이동
                if (currentViewLevel === 3) {
                    // Level 3는 Speaking 방식 사용
                    window.open(`level3-practice-speaking.html?stage=${selectedStage}`, '_blank');
                } else {
                    // Level 1-2는 기존 pattern-training.html 사용
                    const params = new URLSearchParams({
                        level: currentViewLevel,
                        stage: selectedStage,
                        verbs: stageVerbs.join(','),
                        targetAccuracy: level.targetAccuracy,
                        developerMode: isDeveloperMode ? 'true' : 'false'
                    });
                    
                    window.open(`pattern-training.html?${params.toString()}`, '_blank');
                }
            } else {
                alert('먼저 스테이지를 선택해주세요!');
            }
        });

        // 통계 버튼
        document.getElementById('stage-stats-btn').addEventListener('click', () => {
            alert('상세 통계 화면을 표시합니다.');
        });

        // 모드 토글 기능
        function toggleDeveloperMode() {
            isDeveloperMode = !isDeveloperMode;
            
            const toggleSwitch = document.getElementById('toggle-switch');
            const normalLabel = document.getElementById('normal-label');
            const devLabel = document.getElementById('dev-label');
            const devIndicator = document.getElementById('dev-indicator');
            
            if (isDeveloperMode) {
                // 개발자 모드 활성화
                toggleSwitch.classList.add('active');
                normalLabel.classList.remove('active');
                devLabel.classList.add('active');
                devIndicator.classList.add('show');
                console.log('🔧 개발자 모드 활성화 - 모든 레벨 해제됨');
            } else {
                // 일반 모드 활성화
                toggleSwitch.classList.remove('active');
                normalLabel.classList.add('active');
                devLabel.classList.remove('active');
                devIndicator.classList.remove('show');
                console.log('👤 일반 모드 활성화 - 진행률에 따른 잠금');
            }
            
            // 레벨 카드 다시 생성
            createLevelCards();
        }

        // 토글 스위치 이벤트
        document.getElementById('toggle-switch').addEventListener('click', toggleDeveloperMode);

        function updateUserStats() {
            // 기존 진행률 통계
            const completedLevels = userProgress.levels.filter(l => l.completed).length;
            const totalProgress = userProgress.levels.reduce((sum, level) => sum + level.progress, 0) / 10;
            const avgAccuracy = userProgress.levels.length > 0 ? 
                userProgress.levels.reduce((sum, level) => sum + level.bestAccuracy, 0) / userProgress.levels.length : 0;
            
            // localStorage 기반 실제 데이터
            const realStats = StorageManager.getUserStats();
            const mistakes = StorageManager.getMistakes();
            const dueReviews = StorageManager.getDueReviews();
            
            // UI 업데이트
            document.getElementById('user-level').textContent = Math.max(completedLevels, 1);
            document.getElementById('total-progress').textContent = Math.round(totalProgress) + '%';
            
            // 실제 정확도가 있으면 사용, 없으면 가상 데이터 사용
            const displayAccuracy = realStats.averageAccuracy || Math.round(avgAccuracy);
            document.getElementById('accuracy').textContent = displayAccuracy + '%';
            
            // localStorage 기반 추가 통계
            document.getElementById('total-mistakes').textContent = mistakes.length;
            document.getElementById('due-reviews').textContent = dueReviews.length;
            document.getElementById('review-count').textContent = dueReviews.length;
            
            // 복습 대상이 있으면 버튼과 배지 표시
            const reviewBadge = document.getElementById('review-badge');
            if (dueReviews.length > 0) {
                reviewBtn.style.display = 'inline-block';
                reviewBadge.style.display = 'block';
                reviewBadge.textContent = dueReviews.length > 9 ? '9+' : dueReviews.length;
                
                // 복습 대상이 5개 이상이면 강조
                if (dueReviews.length >= 5) {
                    reviewBtn.style.animation = 'pulse 2s infinite';
                }
            } else {
                reviewBtn.style.display = 'none';
                reviewBadge.style.display = 'none';
            }
        }

        // 복습 모드 표시
        function showReviewMode() {
            levelsView.style.display = 'none';
            stageView.style.display = 'none';
            statsView.style.display = 'none';
            reviewView.style.display = 'block';
            
            const dueReviews = StorageManager.getDueReviews();
            const reviewContent = document.getElementById('review-content');
            
            if (dueReviews.length === 0) {
                reviewContent.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #6b7280;">
                        <div style="font-size: 4em; margin-bottom: 20px;">🎉</div>
                        <h3>복습할 문제가 없습니다!</h3>
                        <p>모든 문제를 완벽하게 마스터했거나, 아직 복습 시간이 되지 않았습니다.</p>
                        <button onclick="StorageManager.generateTestMistakes(); location.reload();" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🧪 테스트 데이터 생성하기
                        </button>
                    </div>
                `;
                return;
            }
            
            reviewContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    ${dueReviews.map(mistake => `
                        <div class="review-card" style="background: white; border: 2px solid #f59e0b; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <span style="background: #fbbf24; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                    Level ${mistake.level}-${mistake.stage}
                                </span>
                                <span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                    ${mistake.mistakeCount}번 틀림
                                </span>
                            </div>
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 10px;">
                                ${mistake.korean}
                            </div>
                            <div style="font-size: 16px; color: #059669; margin-bottom: 15px;">
                                ${mistake.english}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 15px;">
                                패턴: ${mistake.pattern} | 동사: ${mistake.verb}
                            </div>
                            <button onclick="startReviewQuestion('${mistake.id}')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                🎯 지금 복습하기
                            </button>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="startAllReview()" style="padding: 15px 30px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 25px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                        📚 모든 복습 문제 한번에 시작하기 (${dueReviews.length}개)
                    </button>
                </div>
            `;
        }

        // 망각곡선 현황 모드 표시
        function showForgettingCurveMode() {
            levelsView.style.display = 'none';
            stageView.style.display = 'none';
            reviewView.style.display = 'none';
            statsView.style.display = 'none';
            forgettingCurveView.style.display = 'block';
            
            const mistakes = StorageManager.getMistakes();
            const curveContent = document.getElementById('curve-content');
            
            if (mistakes.length === 0) {
                curveContent.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #6b7280;">
                        <div style="font-size: 4em; margin-bottom: 20px;">🤔</div>
                        <h3>망각곡선 데이터가 없습니다</h3>
                        <p>학습을 진행하면서 틀린 문제들이 수집되면 망각곡선 현황을 볼 수 있습니다.</p>
                        <button onclick="StorageManager.generateTestMistakes(); location.reload();" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🧪 테스트 데이터 생성하기
                        </button>
                    </div>
                `;
                return;
            }
            
            // 복습 단계별로 문제 분류
            const reviewStages = [
                { stage: 0, name: '1일 대기', interval: '1일', color: '#ef4444' },
                { stage: 1, name: '3일 대기', interval: '3일', color: '#f59e0b' },
                { stage: 2, name: '7일 대기', interval: '7일', color: '#3b82f6' },
                { stage: 3, name: '14일 대기', interval: '14일', color: '#8b5cf6' },
                { stage: 4, name: '마스터 완료', interval: '완료', color: '#10b981' }
            ];
            
            curveContent.innerHTML = `
                <!-- 망각곡선 개요 -->
                <div style="background: #f0f9ff; padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 4px solid #3b82f6;">
                    <h3 style="color: #1e40af; margin-bottom: 15px;">🧠 망각곡선 복습 시스템</h3>
                    <p style="color: #3730a3; margin: 0; line-height: 1.6;">
                        에빙하우스 망각곡선에 따라 <strong>1일 → 3일 → 7일 → 14일</strong> 간격으로 복습하여<br>
                        장기기억에 저장시킵니다. 총 <strong>${mistakes.length}개</strong> 문제가 시스템에 등록되었습니다.
                    </p>
                </div>
                
                <!-- 단계별 현황 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    ${reviewStages.map(stageInfo => {
                        const stageProblems = mistakes.filter(m => 
                            stageInfo.stage === 4 ? m.mastered : (!m.mastered && m.reviewStage === stageInfo.stage)
                        );
                        return `
                            <div style="background: white; padding: 20px; border-radius: 15px; border-left: 4px solid ${stageInfo.color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: #1f2937; margin: 0;">${stageInfo.name}</h4>
                                    <span style="background: ${stageInfo.color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                        ${stageProblems.length}개
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">복습 간격: ${stageInfo.interval}</div>
                                <div style="max-height: 120px; overflow-y: auto;">
                                    ${stageProblems.length > 0 ? 
                                        stageProblems.slice(0, 3).map(mistake => `
                                            <div style="padding: 6px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px;">
                                                <div style="font-weight: 500; color: #1f2937;">${mistake.korean}</div>
                                                <div style="color: #6b7280;">${mistake.english}</div>
                                            </div>
                                        `).join('') + (stageProblems.length > 3 ? `<div style="text-align: center; padding: 8px; color: #6b7280; font-size: 12px;">+${stageProblems.length - 3}개 더</div>` : '')
                                        : '<div style="text-align: center; color: #9ca3af; font-size: 12px; padding: 20px;">문제 없음</div>'
                                    }
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- 상세 문제 목록 -->
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="color: #1f2937; margin-bottom: 20px;">📋 전체 문제 상세 현황</h3>
                    <div style="display: grid; gap: 15px;">
                        ${mistakes.map((mistake, index) => {
                            const stageInfo = reviewStages[mistake.mastered ? 4 : mistake.reviewStage];
                            const timeAgo = StorageManager.getTimeAgo(mistake.firstMistake);
                            const nextReview = mistake.mastered ? '완료' : StorageManager.getTimeUntil(mistake.nextReview);
                            const isDue = !mistake.mastered && mistake.nextReview <= Date.now();
                            
                            return `
                                <div style="background: ${isDue ? '#fef3c7' : '#f9fafb'}; padding: 15px; border-radius: 10px; border-left: 4px solid ${stageInfo.color};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <div style="font-size: 16px; font-weight: bold; color: #1f2937;">
                                            ${mistake.korean} → ${mistake.english}
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            ${isDue ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">복습 가능</span>' : ''}
                                            <span style="background: ${stageInfo.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                                ${stageInfo.name}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 12px; color: #6b7280;">
                                        <div>📅 첫 실수: ${timeAgo}</div>
                                        <div>💔 틀린 횟수: ${mistake.mistakeCount}번</div>
                                        <div>🔄 복습 단계: ${mistake.reviewStage + 1}/4</div>
                                        <div>⏰ 다음 복습: ${nextReview}</div>
                                        <div>📍 레벨: ${mistake.level}-${mistake.stage}</div>
                                        <div>🏷️ 패턴: ${mistake.pattern}</div>
                                    </div>
                                    ${isDue ? `
                                        <div style="margin-top: 10px; text-align: right;">
                                            <button onclick="startReviewQuestion('${mistake.id}')" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                🎯 지금 복습하기
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- 개발자 도구 -->
                <div style="background: #f1f5f9; padding: 20px; border-radius: 15px; border: 2px dashed #cbd5e1; margin-top: 30px;">
                    <h3 style="color: #64748b; margin-bottom: 15px;">🛠️ 망각곡선 테스트 도구</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="StorageManager.accelerateTimeForTesting(); location.reload();" style="padding: 8px 15px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ⚡ 모든 문제 복습 가능하게
                        </button>
                        <button onclick="console.log('망각곡선 데이터:', StorageManager.getMistakes());" style="padding: 8px 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            🔍 콘솔에서 데이터 확인
                        </button>
                        <button onclick="localStorage.removeItem('dasi_mistakes'); location.reload();" style="padding: 8px 15px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            🗑️ 망각곡선 데이터 삭제
                        </button>
                    </div>
                </div>
            `;
        }

        // 통계 모드 표시
        function showStatsMode() {
            levelsView.style.display = 'none';
            stageView.style.display = 'none';
            reviewView.style.display = 'none';
            forgettingCurveView.style.display = 'none';
            statsView.style.display = 'block';
            
            const stats = StorageManager.getUserStats();
            const mistakes = StorageManager.getMistakes();
            const dueReviews = StorageManager.getDueReviews();
            const masteredCount = mistakes.filter(m => m.mastered).length;
            
            // 패턴별 약점 분석
            const patternStats = {};
            mistakes.forEach(mistake => {
                if (!patternStats[mistake.pattern]) {
                    patternStats[mistake.pattern] = { count: 0, mastered: 0 };
                }
                patternStats[mistake.pattern].count++;
                if (mistake.mastered) patternStats[mistake.pattern].mastered++;
            });
            
            const statsContent = document.getElementById('stats-content');
            statsContent.innerHTML = `
                <!-- 전체 통계 카드 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">${stats.totalSessions}</div>
                        <div style="opacity: 0.9;">총 학습 세션</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">${stats.totalQuestions}</div>
                        <div style="opacity: 0.9;">총 문제 수</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">${stats.averageAccuracy}%</div>
                        <div style="opacity: 0.9;">평균 정확도</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">${Math.round(stats.totalStudyTime / 60000)}</div>
                        <div style="opacity: 0.9;">총 학습 시간 (분)</div>
                    </div>
                </div>
                
                <!-- 복습 상태 -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 20px;">🧠 복습 현황</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #ef4444;">
                            <div style="font-size: 2em; font-weight: bold; color: #ef4444;">${mistakes.length}</div>
                            <div style="color: #6b7280; font-size: 14px;">총 틀린 문제</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${dueReviews.length}</div>
                            <div style="color: #6b7280; font-size: 14px;">복습 대기</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #10b981;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">${masteredCount}</div>
                            <div style="color: #6b7280; font-size: 14px;">마스터 완료</div>
                        </div>
                    </div>
                </div>
                
                <!-- 패턴별 약점 분석 -->
                <div style="background: #fef3c7; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: #92400e; margin-bottom: 20px;">📊 패턴별 약점 분석</h3>
                    ${Object.keys(patternStats).length > 0 ? `
                        <div style="display: grid; gap: 10px;">
                            ${Object.entries(patternStats).map(([pattern, data]) => {
                                const masteryRate = data.count > 0 ? Math.round((data.mastered / data.count) * 100) : 0;
                                const isWeak = masteryRate < 50;
                                return `
                                    <div style="background: white; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid ${isWeak ? '#ef4444' : '#10b981'};">
                                        <div>
                                            <strong style="color: #1f2937;">${pattern}</strong>
                                            <div style="font-size: 12px; color: #6b7280;">틀린 횟수: ${data.count}번</div>
                                        </div>
                                        <div style="text-align: right; display: flex; align-items: center; gap: 15px;">
                                            <div>
                                                <div style="font-size: 18px; font-weight: bold; color: ${isWeak ? '#ef4444' : '#10b981'};">
                                                    ${masteryRate}%
                                                </div>
                                                <div style="font-size: 12px; color: #6b7280;">마스터율</div>
                                            </div>
                                            ${isWeak ? `
                                                <button onclick="startPatternTraining('${pattern}')" style="padding: 8px 15px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
                                                    🎯 집중 훈련
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- 약한 패턴 한번에 훈련 -->
                        ${Object.entries(patternStats).some(([_, data]) => data.count > 0 && Math.round((data.mastered / data.count) * 100) < 50) ? `
                            <div style="text-align: center; margin-top: 20px;">
                                <button onclick="startWeakPatternsTraining()" style="padding: 12px 25px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                                    🔥 약한 패턴 모두 집중 훈련하기
                                </button>
                            </div>
                        ` : ''}
                    ` : `
                        <p style="color: #d97706; text-align: center;">아직 분석할 데이터가 충분하지 않습니다.</p>
                    `}
                </div>
                
                <!-- 개발자 도구 -->
                <div style="background: #f1f5f9; padding: 20px; border-radius: 15px; border: 2px dashed #cbd5e1;">
                    <h3 style="color: #64748b; margin-bottom: 15px;">🛠️ 개발자 도구</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="StorageManager.generateTestMistakes(); location.reload();" style="padding: 8px 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            🧪 테스트 데이터 생성
                        </button>
                        <button onclick="StorageManager.accelerateTimeForTesting(); location.reload();" style="padding: 8px 15px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ⚡ 시간 가속
                        </button>
                        <button onclick="localStorage.clear(); location.reload();" style="padding: 8px 15px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            🗑️ 모든 데이터 삭제
                        </button>
                    </div>
                </div>
            `;
        }

        // 메인 화면으로 돌아가기
        function showMainView() {
            levelsView.style.display = 'block';
            stageView.style.display = 'none';
            reviewView.style.display = 'none';
            statsView.style.display = 'none';
            forgettingCurveView.style.display = 'none';
            currentViewLevel = null;
            selectedStage = null;
        }

        // 복습/통계/망각곡선 버튼 이벤트 리스너
        reviewBtn.addEventListener('click', showReviewMode);
        statsBtn.addEventListener('click', showStatsMode);
        forgettingCurveBtn.addEventListener('click', showForgettingCurveMode);
        backFromReviewBtn.addEventListener('click', showMainView);
        backFromStatsBtn.addEventListener('click', showMainView);
        backFromCurveBtn.addEventListener('click', showMainView);

        // 개별 복습 시작 함수 (전역)
        window.startReviewQuestion = function(mistakeId) {
            const mistakes = StorageManager.getMistakes();
            const mistake = mistakes.find(m => m.id === mistakeId);
            
            if (!mistake) {
                alert('복습 문제를 찾을 수 없습니다.');
                return;
            }
            
            // pattern-training.html로 복습 모드로 열기
            const params = new URLSearchParams({
                level: mistake.level,
                stage: mistake.stage,
                verbs: mistake.verb,
                reviewMode: 'single',
                reviewId: mistake.id
            });
            
            window.open(`pattern-training.html?${params.toString()}`, '_blank');
        };

        // 모든 복습 문제 시작 함수 (전역)
        window.startAllReview = function() {
            const dueReviews = StorageManager.getDueReviews();
            
            if (dueReviews.length === 0) {
                alert('복습할 문제가 없습니다.');
                return;
            }
            
            // 복습 문제들의 ID 목록 생성
            const reviewIds = dueReviews.map(mistake => mistake.id).join(',');
            
            // pattern-training.html로 전체 복습 모드로 열기
            const params = new URLSearchParams({
                level: 'mixed',
                stage: 'review',
                reviewMode: 'all',
                reviewIds: reviewIds
            });
            
            window.open(`pattern-training.html?${params.toString()}`, '_blank');
        };

        // 특정 패턴 집중 훈련 함수 (전역)
        window.startPatternTraining = function(pattern) {
            const mistakes = StorageManager.getMistakes();
            const patternMistakes = mistakes.filter(m => m.pattern === pattern && !m.mastered);
            
            if (patternMistakes.length === 0) {
                alert('해당 패턴에 대한 훈련 문제가 없습니다.');
                return;
            }
            
            const reviewIds = patternMistakes.map(mistake => mistake.id).join(',');
            
            // pattern-training.html로 패턴 집중 훈련 모드로 열기
            const params = new URLSearchParams({
                level: 'pattern',
                stage: pattern,
                reviewMode: 'pattern',
                reviewIds: reviewIds,
                patternName: pattern
            });
            
            window.open(`pattern-training.html?${params.toString()}`, '_blank');
        };

        // 약한 패턴 모두 집중 훈련 함수 (전역)
        window.startWeakPatternsTraining = function() {
            const mistakes = StorageManager.getMistakes();
            
            // 패턴별 약점 분석
            const patternStats = {};
            mistakes.forEach(mistake => {
                if (!patternStats[mistake.pattern]) {
                    patternStats[mistake.pattern] = { count: 0, mastered: 0 };
                }
                patternStats[mistake.pattern].count++;
                if (mistake.mastered) patternStats[mistake.pattern].mastered++;
            });
            
            // 마스터율 50% 미만인 패턴들의 문제만 수집
            const weakPatternMistakes = [];
            Object.entries(patternStats).forEach(([pattern, data]) => {
                const masteryRate = data.count > 0 ? Math.round((data.mastered / data.count) * 100) : 0;
                if (masteryRate < 50) {
                    const patternMistakes = mistakes.filter(m => m.pattern === pattern && !m.mastered);
                    weakPatternMistakes.push(...patternMistakes);
                }
            });
            
            if (weakPatternMistakes.length === 0) {
                alert('약한 패턴이 없습니다! 모든 패턴이 양호한 상태입니다.');
                return;
            }
            
            const reviewIds = weakPatternMistakes.map(mistake => mistake.id).join(',');
            
            // pattern-training.html로 약한 패턴 집중 훈련 모드로 열기
            const params = new URLSearchParams({
                level: 'weak-patterns',
                stage: 'mixed',
                reviewMode: 'weak-patterns',
                reviewIds: reviewIds
            });
            
            window.open(`pattern-training.html?${params.toString()}`, '_blank');
        };

        // 초기화
        createLevelCards();
        updateUserStats();
        
        // 정기적으로 복습 상태 업데이트 (1분마다)
        setInterval(updateUserStats, 60000);
        
        // 첫 번째 스테이지 선택 (스테이지 뷰가 열렸을 때만)
        setTimeout(() => {
            if (currentViewLevel && stageView.style.display !== 'none') {
                const userLevelData = userProgress.levels.find(l => l.level === currentViewLevel);
                if (userLevelData?.stages) {
                    // 진행중인 스테이지 찾기
                    let targetStage = userLevelData.stages.findIndex(s => !s.completed) + 1;
                    if (targetStage === 0) targetStage = 1; // 모든 스테이지가 완료된 경우
                    selectStage(currentViewLevel, targetStage);
                } else {
                    selectStage(currentViewLevel, 1);
                }
            }
        }, 500);
    </script>
</body>
</html>